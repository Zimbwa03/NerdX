{% extends "base.html" %}

{% block title %}Admin Users - NerdX Dashboard{% endblock %}

{% block extra_head %}
<style>
    .admin-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 15px;
    }
    
    .admin-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
    }
    
    .admin-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
    }
    
    .admin-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        margin-right: 1rem;
    }
    
    .role-badge {
        border-radius: 20px;
        padding: 0.3rem 0.8rem;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .role-super-admin {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
    }
    
    .role-admin {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }
    
    .status-badge {
        border-radius: 20px;
        padding: 0.3rem 0.8rem;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    
    .action-btn {
        border: none;
        border-radius: 8px;
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        margin: 0 0.2rem;
    }
    
    .btn-deactivate {
        background: #dc3545;
        color: white;
    }
    
    .btn-deactivate:hover {
        background: #c82333;
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-add-admin {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border: none;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        padding: 0.8rem 1.5rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
    }
    
    .btn-add-admin:hover {
        color: white;
        text-decoration: none;
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(79, 172, 254, 0.3);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #666;
    }
    
    .empty-state-icon {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .loading-spinner {
        width: 3rem;
        height: 3rem;
        border: 0.3rem solid #f3f3f3;
        border-top: 0.3rem solid #4facfe;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .admin-card .row {
            text-align: center;
        }
        
        .admin-avatar {
            margin: 0 auto 1rem auto;
        }
        
        .action-btn {
            margin: 0.2rem;
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-users-cog me-3"></i>Admin Users Management
                    </h1>
                    <p class="mb-0 opacity-75">
                        Manage administrator accounts and permissions for the NerdX dashboard
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="/register" class="btn-add-admin">
                        <i class="fas fa-user-plus me-2"></i>Add New Admin
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success/Error Alerts -->
    <div id="alertContainer"></div>
    
    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="totalAdmins">0</div>
                <div>Total Admins</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="activeAdmins">0</div>
                <div>Active Admins</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="superAdmins">0</div>
                <div>Super Admins</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="recentLogins">0</div>
                <div>Recent Logins (7d)</div>
            </div>
        </div>
    </div>
    
    <!-- Admin Users List -->
    <div class="card shadow">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Administrator Accounts
            </h5>
        </div>
        <div class="card-body">
            <div id="adminsList">
                <!-- Admin cards will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Action
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> This action cannot be undone. The admin will lose access to the dashboard immediately.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">
                    <i class="fas fa-check me-2"></i>Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentAction = null;
let currentAdminId = null;

// Show loading
function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

// Hide loading
function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

// Show alert
function showAlert(message, type = 'success') {
    const alertContainer = document.getElementById('alertContainer');
    const alertId = 'alert-' + Date.now();
    
    const alertHtml = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    alertContainer.innerHTML = alertHtml;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) {
            alert.remove();
        }
    }, 5000);
    
    // Scroll to top
    window.scrollTo(0, 0);
}

// Get admin initials
function getInitials(firstName, lastName) {
    return (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
}

// Format date
function formatDate(dateString) {
    if (!dateString) return 'Never';
    
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) return 'Yesterday';
    if (diffDays <= 7) return `${diffDays} days ago`;
    
    return date.toLocaleDateString();
}

// Render admin card
function renderAdminCard(admin) {
    const isCurrentUser = admin.email === '{{ admin_user.email }}';
    const canDeactivate = admin.role !== 'super_admin' && !isCurrentUser;
    
    return `
        <div class="admin-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <div class="admin-avatar">
                                ${getInitials(admin.first_name, admin.last_name)}
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="mb-1">
                                    ${admin.full_name}
                                    ${isCurrentUser ? '<small class="text-muted">(You)</small>' : ''}
                                </h5>
                                <p class="mb-1 text-muted">${admin.email}</p>
                                ${admin.phone_number ? `<p class="mb-0 text-muted small"><i class="fas fa-phone me-1"></i>${admin.phone_number}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="mb-2">
                            <span class="role-badge ${admin.role === 'super_admin' ? 'role-super-admin' : 'role-admin'}">
                                <i class="fas fa-${admin.role === 'super_admin' ? 'crown' : 'user-shield'} me-1"></i>
                                ${admin.role === 'super_admin' ? 'Super Admin' : 'Admin'}
                            </span>
                            <span class="status-badge ${admin.is_active ? 'status-active' : 'status-inactive'} ms-1">
                                <i class="fas fa-${admin.is_active ? 'check-circle' : 'times-circle'} me-1"></i>
                                ${admin.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <div class="small text-muted mb-2">
                            <i class="fas fa-clock me-1"></i>
                            Last login: ${formatDate(admin.last_login)}
                        </div>
                        <div class="small text-muted mb-2">
                            <i class="fas fa-calendar me-1"></i>
                            Created: ${formatDate(admin.created_at)}
                            ${admin.created_by ? `<br><i class="fas fa-user me-1"></i>By: ${admin.created_by}` : ''}
                        </div>
                        ${canDeactivate ? `
                            <button class="action-btn btn-deactivate" onclick="confirmDeactivate(${admin.id}, '${admin.full_name}')">
                                <i class="fas fa-ban me-1"></i>Deactivate
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Load admin users
async function loadAdminUsers() {
    showLoading();
    
    try {
        const response = await fetch('/api/admin-users');
        const data = await response.json();
        
        if (data.success) {
            const adminsList = document.getElementById('adminsList');
            const users = data.users;
            
            if (users.length === 0) {
                adminsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h4>No Administrators Found</h4>
                        <p>Start by adding your first administrator account.</p>
                        <a href="/register" class="btn-add-admin">
                            <i class="fas fa-user-plus me-2"></i>Add First Admin
                        </a>
                    </div>
                `;
            } else {
                adminsList.innerHTML = users.map(renderAdminCard).join('');
            }
            
            // Update statistics
            updateStatistics(users);
            
        } else {
            showAlert(data.message || 'Failed to load admin users', 'danger');
        }
        
    } catch (error) {
        console.error('Error loading admin users:', error);
        showAlert('Network error. Please try again.', 'danger');
    } finally {
        hideLoading();
    }
}

// Update statistics
function updateStatistics(users) {
    const totalAdmins = users.length;
    const activeAdmins = users.filter(u => u.is_active).length;
    const superAdmins = users.filter(u => u.role === 'super_admin').length;
    
    // Calculate recent logins (last 7 days)
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const recentLogins = users.filter(u => {
        return u.last_login && new Date(u.last_login) > weekAgo;
    }).length;
    
    document.getElementById('totalAdmins').textContent = totalAdmins;
    document.getElementById('activeAdmins').textContent = activeAdmins;
    document.getElementById('superAdmins').textContent = superAdmins;
    document.getElementById('recentLogins').textContent = recentLogins;
}

// Confirm deactivation
function confirmDeactivate(adminId, adminName) {
    currentAction = 'deactivate';
    currentAdminId = adminId;
    
    document.getElementById('confirmMessage').textContent = 
        `Are you sure you want to deactivate ${adminName}? They will lose access to the dashboard immediately.`;
    
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

// Handle confirmation
document.getElementById('confirmActionBtn').addEventListener('click', async function() {
    if (currentAction === 'deactivate' && currentAdminId) {
        await deactivateAdmin(currentAdminId);
    }
    
    // Hide modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
    modal.hide();
    
    // Reset
    currentAction = null;
    currentAdminId = null;
});

// Deactivate admin
async function deactivateAdmin(adminId) {
    showLoading();
    
    try {
        const response = await fetch(`/api/admin-users/${adminId}/deactivate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            // Reload the list
            loadAdminUsers();
        } else {
            showAlert(data.message || 'Failed to deactivate admin', 'danger');
            hideLoading();
        }
        
    } catch (error) {
        console.error('Error deactivating admin:', error);
        showAlert('Network error. Please try again.', 'danger');
        hideLoading();
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadAdminUsers();
    
    // Auto-refresh every 30 seconds
    setInterval(loadAdminUsers, 30000);
});
</script>
{% endblock %}
