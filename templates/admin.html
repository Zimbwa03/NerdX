{% extends "base.html" %}

{% block title %}Admin Panel - NerdX Quiz Bot{% endblock %}

{% block extra_head %}
<style>
/* Teacher AI Chat Interface */
.ti-chat-bubble {
    display: flex;
    gap: 10px;
    max-width: 95%;
    animation: tiFadeIn 0.3s ease;
}
@keyframes tiFadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}
.ti-chat-bubble.ti-chat-user {
    flex-direction: row-reverse;
    align-self: flex-end;
}
.ti-chat-bubble.ti-chat-ai {
    align-self: flex-start;
}
.ti-chat-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 0.8rem;
}
.ti-chat-ai .ti-chat-avatar {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
}
.ti-chat-user .ti-chat-avatar {
    background: linear-gradient(135deg, #3b82f6, #06b6d4);
    color: #fff;
}
.ti-chat-content {
    flex: 1;
    min-width: 0;
}
.ti-chat-text {
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 0.85rem;
    line-height: 1.5;
    word-wrap: break-word;
    white-space: pre-wrap;
}
.ti-chat-ai .ti-chat-text {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.08);
    border-top-left-radius: 4px;
    color: rgba(255,255,255,0.9);
}
.ti-chat-user .ti-chat-text {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border-top-right-radius: 4px;
    color: #fff;
}
.ti-chat-meta {
    font-size: 0.65rem;
    opacity: 0.5;
    margin-top: 4px;
    padding: 0 6px;
}
.ti-chat-user .ti-chat-meta {
    text-align: right;
}
.ti-chat-typing {
    display: flex;
    gap: 4px;
    padding: 12px 16px;
}
.ti-chat-typing span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    animation: tiTypingBounce 1.4s infinite ease-in-out;
}
.ti-chat-typing span:nth-child(2) { animation-delay: 0.16s; }
.ti-chat-typing span:nth-child(3) { animation-delay: 0.32s; }
@keyframes tiTypingBounce {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
    40% { transform: scale(1); opacity: 1; }
}
/* Scrollbar styling for chat */
#tiChatMessages::-webkit-scrollbar { width: 5px; }
#tiChatMessages::-webkit-scrollbar-track { background: transparent; }
#tiChatMessages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
#tiChatMessages::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }
/* Auto-grow textarea */
#tiAiPrompt { overflow: hidden; }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h3 mb-0">
            <i class="fas fa-cog me-2"></i>
            Admin Panel
        </h1>
        <p class="text-muted">Manage users, credits, and system settings</p>
    </div>
</div>

<!-- Admin Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
            <i class="fas fa-users me-1"></i>
            User Management
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="credits-tab" data-bs-toggle="tab" data-bs-target="#credits" type="button" role="tab">
            <i class="fas fa-coins me-1"></i>
            Credit Management
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button" role="tab">
            <i class="fas fa-question-circle me-1"></i>
            Question Generation
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">
            <i class="fas fa-credit-card me-1"></i>
            Payments
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="teachers-intelligence-tab" data-bs-toggle="tab" data-bs-target="#teachers-intelligence" type="button" role="tab">
            <i class="fas fa-chalkboard-teacher me-1"></i>
            Teacher Intelligence
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
            <i class="fas fa-sliders-h me-1"></i>
            Settings
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="adminTabContent">
    <!-- User Management Tab -->
    <div class="tab-pane fade show active" id="users" role="tabpanel">
        <div class="row mb-3">
            <div class="col-md-8">
                <div class="input-group">
                    <input type="text" class="form-control" id="userSearch" placeholder="Search users by name, NerdX ID, or WhatsApp ID">
                    <select class="form-select" id="searchType" style="max-width: 150px;">
                        <option value="name">Name</option>
                        <option value="nerdx_id">NerdX ID</option>
                        <option value="whatsapp_id">WhatsApp ID</option>
                    </select>
                    <button class="btn btn-primary" onclick="searchUsers()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-success" onclick="exportUsers()">
                    <i class="fas fa-download me-1"></i>
                    Export Users
                </button>
            </div>
        </div>

        <!-- Users Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>NerdX ID</th>
                                <th>Name</th>
                                <th>Credits</th>
                                <th>Points</th>
                                <th>Streak</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="fas fa-search me-2"></i>
                                    Search for users to display results
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Credit Management Tab -->
    <div class="tab-pane fade" id="credits" role="tabpanel">
        <!-- Credit Statistics Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="h4 mb-0" id="totalUsers">-</div>
                                <div class="small">Total Users</div>
                            </div>
                            <div class="fa-2x">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="h4 mb-0" id="totalCredits">-</div>
                                <div class="small">Total Credits</div>
                            </div>
                            <div class="fa-2x">
                                <i class="fas fa-coins"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="h4 mb-0" id="avgCredits">-</div>
                                <div class="small">Avg Credits</div>
                            </div>
                            <div class="fa-2x">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="h4 mb-0" id="lowCreditUsers">-</div>
                                <div class="small">Low Credit Users</div>
                            </div>
                            <div class="fa-2x">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Individual Credit Management -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-user-edit me-2"></i>
                            Individual Credit Management
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="creditForm">
                            <div class="mb-3">
                                <label for="creditUserId" class="form-label">User ID (WhatsApp ID)</label>
                                <input type="text" class="form-control" id="creditUserId" required>
                            </div>
                            <div class="mb-3">
                                <label for="creditAction" class="form-label">Action</label>
                                <select class="form-select" id="creditAction" required>
                                    <option value="">Select action</option>
                                    <option value="add">Add Credits</option>
                                    <option value="deduct">Deduct Credits</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="creditAmount" class="form-label">Amount</label>
                                <input type="number" class="form-control" id="creditAmount" min="1" max="10000" required>
                            </div>
                            <div class="mb-3">
                                <label for="creditReason" class="form-label">Reason</label>
                                <input type="text" class="form-control" id="creditReason" placeholder="e.g., admin adjustment, bonus" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-coins me-1"></i>
                                Process Credits
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Credit Reset Section -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-redo me-2"></i>
                            Reset User Credits
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="resetCreditForm">
                            <div class="mb-3">
                                <label for="resetUserId" class="form-label">User ID</label>
                                <input type="text" class="form-control" id="resetUserId" required>
                            </div>
                            <div class="mb-3">
                                <label for="resetAmount" class="form-label">New Credit Amount</label>
                                <input type="number" class="form-control" id="resetAmount" value="1000" min="0" max="50000" required>
                            </div>
                            <div class="mb-3">
                                <label for="resetReason" class="form-label">Reason</label>
                                <input type="text" class="form-control" id="resetReason" value="Admin credit reset" required>
                            </div>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-redo me-1"></i>
                                Reset Credits
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Bulk Credit Operations -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-users-cog me-2"></i>
                            Bulk Credit Operations
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="bulkCreditForm">
                            <div class="mb-3">
                                <label for="bulkTarget" class="form-label">Target Group</label>
                                <select class="form-select" id="bulkTarget" required>
                                    <option value="all">All Users</option>
                                    <option value="low_credits">Low Credit Users (&lt;50)</option>
                                    <option value="specific_users">Specific Users</option>
                                </select>
                            </div>
                            <div class="mb-3" id="specificUsersDiv" style="display: none;">
                                <label for="specificUserIds" class="form-label">User IDs (comma-separated)</label>
                                <textarea class="form-control" id="specificUserIds" rows="3" placeholder="user1, user2, user3..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="bulkAmount" class="form-label">Credits to Add</label>
                                <input type="number" class="form-control" id="bulkAmount" value="500" min="1" max="10000" required>
                            </div>
                            <div class="mb-3">
                                <label for="bulkReason" class="form-label">Reason</label>
                                <input type="text" class="form-control" id="bulkReason" value="Admin bulk credit refresh" required>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-magic me-1"></i>
                                Refresh Credits
                            </button>
                        </form>

                        <!-- Quick Actions -->
                        <hr>
                        <h6>Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="quickBulkCredits(500, 'all')">
                                <i class="fas fa-plus"></i> Give All Users +500 Credits
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="quickBulkCredits(1000, 'low_credits')">
                                <i class="fas fa-battery-quarter"></i> Help Low Credit Users (+1000)
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="quickBulkCredits(2000, 'all')">
                                <i class="fas fa-gift"></i> MEGA Credits for Everyone (+2000)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Credit Statistics & Top Users -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-trophy me-2"></i>
                            Top Users by Credits
                        </h6>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="topUsersList">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <small class="d-block mt-2">Loading...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>
                            Recent Credit Transactions
                        </h6>
                    </div>
                    <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                        <div id="recentTransactions">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <small class="d-block mt-2">Loading...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Operation Results Modal -->
        <div class="modal fade" id="bulkResultModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Bulk Operation Results</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="bulkResultContent">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Generation Tab -->
    <div class="tab-pane fade" id="questions" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-plus me-2"></i>
                            Generate Questions
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="questionForm">
                            <div class="mb-3">
                                <label for="questionSubject" class="form-label">Subject</label>
                                <select class="form-select" id="questionSubject" required>
                                    <option value="">Select subject</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Biology">Biology</option>
                                    <option value="Chemistry">Chemistry</option>
                                    <option value="Physics">Physics</option>
                                    <option value="English">English</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="questionTopic" class="form-label">Topic</label>
                                <select class="form-select" id="questionTopic" required>
                                    <option value="">Select topic</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="questionDifficulty" class="form-label">Difficulty</label>
                                <select class="form-select" id="questionDifficulty" required>
                                    <option value="">Select difficulty</option>
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="difficult">Difficult</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="questionCount" class="form-label">Number of Questions</label>
                                <input type="number" class="form-control" id="questionCount" min="1" max="10" value="1" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-magic me-1"></i>
                                Generate Questions
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            Generated Questions
                        </h6>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="generatedQuestions">
                            <p class="text-muted text-center">
                                <i class="fas fa-lightbulb me-2"></i>
                                Generated questions will appear here
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payments Tab -->
    <div class="tab-pane fade" id="payments" role="tabpanel">
        <div class="row mb-3">
            <div class="col">
                <h5><i class="fas fa-credit-card me-2"></i>Payment Management Dashboard</h5>
                <p class="text-muted">Manage payment approvals, view statistics, and monitor transactions</p>
            </div>
        </div>
        
        <!-- Payment Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                        <h4 class="mb-0" id="pendingPayments">0</h4>
                        <small class="text-muted">Pending Approvals</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <i class="fas fa-dollar-sign fa-2x text-success mb-2"></i>
                        <h4 class="mb-0" id="totalRevenue">$0.00</h4>
                        <small class="text-muted">Total Revenue (30d)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h4 class="mb-0" id="approvedPayments">0</h4>
                        <small class="text-muted">Approved (30d)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                        <h4 class="mb-0" id="rejectedPayments">0</h4>
                        <small class="text-muted">Rejected (30d)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Management Tabs -->
        <ul class="nav nav-tabs mb-3" id="paymentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                    <i class="fas fa-clock me-1"></i>
                    Pending Approvals
                    <span class="badge bg-warning ms-1" id="pendingBadge">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab">
                    <i class="fas fa-check me-1"></i>
                    Approved Payments
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab">
                    <i class="fas fa-times me-1"></i>
                    Rejected Payments
                </button>
            </li>
        </ul>

        <!-- Payment Tab Content -->
        <div class="tab-content" id="paymentTabContent">
            <!-- Pending Payments Tab -->
            <div class="tab-pane fade show active" id="pending" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-clock me-2"></i>
                            Pending Payment Approvals
                        </h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshPendingPayments()">
                            <i class="fas fa-sync-alt me-1"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="pendingPaymentsContent">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p>Loading pending payments...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Approved Payments Tab -->
            <div class="tab-pane fade" id="approved" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-check me-2"></i>
                            Approved Payments (Last 30 Days)
                        </h6>
                        <button class="btn btn-sm btn-outline-success" onclick="refreshApprovedPayments()">
                            <i class="fas fa-sync-alt me-1"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="approvedPaymentsContent">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p>Loading approved payments...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rejected Payments Tab -->
            <div class="tab-pane fade" id="rejected" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-times me-2"></i>
                            Rejected Payments (Last 30 Days)
                        </h6>
                        <button class="btn btn-sm btn-outline-danger" onclick="refreshRejectedPayments()">
                            <i class="fas fa-sync-alt me-1"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="rejectedPaymentsContent">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p>Loading rejected payments...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Intelligence Tab -->
    <div class="tab-pane fade" id="teachers-intelligence" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h5 class="mb-1">
                    <i class="fas fa-robot me-2 text-primary"></i>
                    Advanced Teacher Monitoring
                </h5>
                <p class="text-muted mb-0">Track applications, verification documents, performance metrics, and AI analysis.</p>
            </div>
            <button class="btn btn-outline-primary" id="tiRefreshBtn" type="button">
                <i class="fas fa-sync-alt me-1"></i>
                Refresh Data
            </button>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-lg-3 col-md-6">
                <div class="card border-start border-primary border-4 shadow-sm h-100">
                    <div class="card-body">
                        <div class="small text-muted">Teachers In View</div>
                        <div class="h4 mb-0" id="tiTotalTeachers">0</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card border-start border-warning border-4 shadow-sm h-100">
                    <div class="card-body">
                        <div class="small text-muted">New Applications</div>
                        <div class="h4 mb-0" id="tiNewApplications">0</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card border-start border-success border-4 shadow-sm h-100">
                    <div class="card-body">
                        <div class="small text-muted">Verified Teachers</div>
                        <div class="h4 mb-0" id="tiVerifiedTeachers">0</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card border-start border-danger border-4 shadow-sm h-100">
                    <div class="card-body">
                        <div class="small text-muted">Not Verified</div>
                        <div class="h4 mb-0" id="tiNotVerifiedTeachers">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-3">
            <div class="card-body py-3">
                <div class="row text-center">
                    <div class="col-md-3 mb-2 mb-md-0">
                        <div class="fw-bold fs-5" id="tiLessonsCompleted">0</div>
                        <div class="small text-muted">Lessons Completed</div>
                    </div>
                    <div class="col-md-3 mb-2 mb-md-0">
                        <div class="fw-bold fs-5" id="tiUpcomingLessons">0</div>
                        <div class="small text-muted">Upcoming Lessons</div>
                    </div>
                    <div class="col-md-3 mb-2 mb-md-0">
                        <div class="fw-bold fs-5" id="tiTotalStudents">0</div>
                        <div class="small text-muted">Total Student Reach</div>
                    </div>
                    <div class="col-md-3">
                        <div class="fw-bold fs-5" id="tiTotalPosts">0</div>
                        <div class="small text-muted">Teacher Posts</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Verification Status Graph</h6>
                    </div>
                    <div class="card-body" id="tiStatusGraph">
                        <div class="text-muted small">No data loaded yet.</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-signal me-2"></i>Top Teacher Performance Graph</h6>
                    </div>
                    <div class="card-body" id="tiPerformanceGraph">
                        <div class="text-muted small">No data loaded yet.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-xl-8">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-search me-2"></i>Teacher Applications and Progress</h6>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm" id="tiSearchInput" placeholder="Search teacher by name, email, subject..." style="width: 240px;">
                            <select class="form-select form-select-sm" id="tiStatusFilter" style="width: 170px;">
                                <option value="all">All</option>
                                <option value="new">New Applications</option>
                                <option value="pending">Pending Review</option>
                                <option value="approved">Verified</option>
                                <option value="rejected">Rejected</option>
                                <option value="not_verified">Not Verified</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="px-3 py-2 border-bottom small text-muted">
                            Showing <span id="tiFilteredCount">0</span> teachers
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Teacher</th>
                                        <th>Verification</th>
                                        <th style="min-width: 170px;">Progress</th>
                                        <th>Lessons</th>
                                        <th>Students</th>
                                        <th>Posts</th>
                                        <th>Rating</th>
                                        <th>Documents</th>
                                        <th>View</th>
                                    </tr>
                                </thead>
                                <tbody id="tiTeachersTable">
                                    <tr>
                                        <td colspan="9" class="text-center text-muted py-4">Open this tab to load teacher intelligence data.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-4">
                <div class="card shadow-sm h-100 d-flex flex-column" id="tiAiChatCard">
                    <div class="card-header d-flex justify-content-between align-items-center" style="border-bottom: 1px solid rgba(255,255,255,0.08);">
                        <h6 class="mb-0"><i class="fas fa-brain me-2"></i>AI Teacher Assistant</h6>
                        <div class="d-flex align-items-center gap-2">
                            <select id="tiAiTeacherSelect" class="form-select form-select-sm" style="width: auto; max-width: 160px; font-size: 0.75rem; background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.12); color: inherit;">
                                <option value="">All Teachers</option>
                            </select>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="tiClearChat()" title="Clear chat" style="padding: 2px 8px; font-size: 0.7rem;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="tiChatMessages" style="flex: 1 1 auto; overflow-y: auto; padding: 16px; min-height: 320px; max-height: 480px; display: flex; flex-direction: column; gap: 12px; background: rgba(0,0,0,0.15);">
                        <!-- Welcome message -->
                        <div class="ti-chat-bubble ti-chat-ai">
                            <div class="ti-chat-avatar"><i class="fas fa-robot"></i></div>
                            <div class="ti-chat-content">
                                <div class="ti-chat-text">Hello! I'm your <strong>Teacher Intelligence Agent</strong>. I can help you with:<br>
                                    <span style="opacity:0.85;">- Verification status and pending reviews<br>
                                    - Teacher performance and activity metrics<br>
                                    - Document and certificate analysis<br>
                                    - Recommendations for teacher management</span><br><br>
                                    Ask me anything about your teachers!
                                </div>
                                <div class="ti-chat-meta">Vertex AI &middot; Gemini 2.5 Flash</div>
                            </div>
                        </div>
                    </div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.08); padding: 12px;">
                        <form id="tiAiForm" class="d-flex gap-2 align-items-end">
                            <textarea id="tiAiPrompt" class="form-control form-control-sm" rows="1" placeholder="Ask about teachers..." style="resize: none; background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.12); color: inherit; flex: 1; max-height: 80px;" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();document.getElementById('tiAiForm').requestSubmit();}"></textarea>
                            <button type="submit" class="btn btn-primary btn-sm" id="tiAiAskBtn" style="height: 36px; width: 36px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0;">
                                <i class="fas fa-paper-plane" style="font-size: 0.8rem;"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-id-card me-2"></i>Teacher Detail and Verification Documents</h6>
                <span class="small text-muted" id="tiDetailTimestamp">No teacher selected</span>
            </div>
            <div class="card-body" id="tiTeacherDetail">
                <div class="text-muted">Select a teacher to inspect full application details, certificates, and progress steps.</div>
            </div>
        </div>
    </div>

    <!-- Reject Teacher Modal -->
    <div class="modal fade" id="tiRejectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: #1a1d2e; border: 1px solid rgba(255,255,255,0.1);">
                <div class="modal-header border-0">
                    <h6 class="modal-title"><i class="fas fa-times-circle text-danger me-2"></i>Reject Teacher Application</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-3">Please provide a reason for rejecting this teacher's application. This helps maintain transparency.</p>
                    <textarea id="tiRejectReason" class="form-control form-control-sm" rows="3" placeholder="Reason for rejection (e.g., incomplete documents, unverifiable credentials...)" style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.12); color: inherit;"></textarea>
                    <input type="hidden" id="tiRejectTeacherId" value="">
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="tiConfirmReject()">
                        <i class="fas fa-times-circle me-1"></i>Confirm Rejection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="settings" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-cog me-2"></i>
                            System Settings
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="settingsForm">
                            <h6 class="mb-3">Credit Costs</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Math Easy</label>
                                    <input type="number" class="form-control" id="mathEasy" value="5">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Math Medium</label>
                                    <input type="number" class="form-control" id="mathMedium" value="10">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Math Difficult</label>
                                    <input type="number" class="form-control" id="mathDifficult" value="20">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Science Easy</label>
                                    <input type="number" class="form-control" id="scienceEasy" value="5">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Science Medium</label>
                                    <input type="number" class="form-control" id="scienceMedium" value="10">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Science Difficult</label>
                                    <input type="number" class="form-control" id="scienceDifficult" value="15">
                                </div>
                            </div>

                            <hr>
                            
                            <h6 class="mb-3">Rate Limiting</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Session Cooldown (seconds)</label>
                                    <input type="number" class="form-control" id="sessionCooldown" value="30">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Generation Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="generationTimeout" value="120">
                                </div>
                            </div>

                            <hr>
                            
                            <h6 class="mb-3">Bonuses</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Welcome Credits</label>
                                    <input type="number" class="form-control" id="welcomeCredits" value="50">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Referrer Bonus</label>
                                    <input type="number" class="form-control" id="referrerBonus" value="25">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">New User Referral Bonus</label>
                                    <input type="number" class="form-control" id="newUserBonus" value="15">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>
                                Save Settings
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-broadcast-tower me-2"></i>
                            Broadcast Message
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="broadcastForm">
                            <div class="mb-3">
                                <label for="broadcastTarget" class="form-label">Target</label>
                                <select class="form-select" id="broadcastTarget">
                                    <option value="all">All Users</option>
                                    <option value="active">Active Users (Last 7 days)</option>
                                    <option value="inactive">Inactive Users (7+ days)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="broadcastMessage" class="form-label">Message</label>
                                <textarea class="form-control" id="broadcastMessage" rows="4" maxlength="1000" placeholder="Enter broadcast message..."></textarea>
                                <div class="form-text">Max 1000 characters</div>
                            </div>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-bullhorn me-1"></i>
                                Send Broadcast
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Broadcast History -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>
                            Recent Broadcasts
                        </h6>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="broadcastHistory">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <small class="d-block mt-2">Loading...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Topics data for dynamic loading
const TOPICS = {
    "Mathematics": ["Real Numbers", "Sets", "Financial Mathematics", "Measures and Mensuration", "Graphs", "Variation", "Algebra", "Geometry", "Statistics", "Trigonometry", "Vectors", "Matrices", "Transformation", "Probability"],
    "Biology": ["Laboratory rules and safety", "Cells and levels of organization", "Nutrition", "Respiratory system", "Transport systems", "Reproduction in plants and animals", "Health and diseases"],
    "Chemistry": ["Matter", "Acids, Bases and Salts", "Oxidation and Reduction", "Industrial Processes", "Organic Chemistry"],
    "Physics": ["Measurements", "Force", "Energy", "Magnetism", "Electricity"],
    "English": ["Formal Letter Writing", "Informal Letter Writing", "Article Writing", "Report Writing", "Speech Writing", "Narrative Essays", "Descriptive Essays", "Argumentative Essays", "Comprehension Skills", "Vocabulary Building", "Grammar and Language", "Literary Devices", "Reading Skills", "Writing Skills"]
};

const teacherIntelState = {
    loaded: false,
    teachers: [],
    selectedTeacherId: null
};
let teacherSearchDebounce = null;

function tiEscapeHtml(value) {
    return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function tiNumber(value) {
    return Number(value || 0).toLocaleString();
}

function tiStatusLabel(status) {
    const normalized = String(status || 'pending').toLowerCase();
    if (normalized === 'approved') return 'Verified';
    if (normalized === 'rejected') return 'Rejected';
    return 'Pending Review';
}

function tiStatusBadgeClass(status) {
    const normalized = String(status || 'pending').toLowerCase();
    if (normalized === 'approved') return 'bg-success';
    if (normalized === 'rejected') return 'bg-danger';
    return 'bg-warning text-dark';
}

function tiRenderSummary(summary) {
    const inView = summary?.in_view || {};
    const activity = inView.activity || {};
    document.getElementById('tiTotalTeachers').textContent = tiNumber(inView.total_teachers);
    document.getElementById('tiNewApplications').textContent = tiNumber(inView.new_applications);
    document.getElementById('tiVerifiedTeachers').textContent = tiNumber(inView.verified_teachers);
    document.getElementById('tiNotVerifiedTeachers').textContent = tiNumber(inView.not_verified_teachers);
    document.getElementById('tiLessonsCompleted').textContent = tiNumber(activity.total_lessons_completed);
    document.getElementById('tiUpcomingLessons').textContent = tiNumber(activity.upcoming_lessons);
    document.getElementById('tiTotalStudents').textContent = tiNumber(activity.total_students);
    document.getElementById('tiTotalPosts').textContent = tiNumber(activity.total_posts);
}

function tiRenderStatusGraph(distribution) {
    const container = document.getElementById('tiStatusGraph');
    if (!container) return;
    if (!distribution || distribution.length === 0) {
        container.innerHTML = '<div class="text-muted small">No verification data available.</div>';
        return;
    }

    const maxCount = Math.max(...distribution.map((item) => Number(item.count || 0)), 1);
    container.innerHTML = distribution.map((item) => {
        const count = Number(item.count || 0);
        const width = Math.max((count / maxCount) * 100, count > 0 ? 8 : 2);
        const statusClass = item.status === 'approved'
            ? 'bg-success'
            : item.status === 'rejected'
                ? 'bg-danger'
                : 'bg-warning';
        return `
            <div class="mb-3">
                <div class="d-flex justify-content-between small mb-1">
                    <span>${tiEscapeHtml(item.label || item.status)}</span>
                    <span class="fw-semibold">${tiNumber(count)}</span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${width}%"></div>
                </div>
            </div>
        `;
    }).join('');
}

function tiRenderPerformanceGraph(performanceGraph) {
    const container = document.getElementById('tiPerformanceGraph');
    if (!container) return;
    if (!performanceGraph || performanceGraph.length === 0) {
        container.innerHTML = '<div class="text-muted small">No performance data available.</div>';
        return;
    }

    const maxLessons = Math.max(...performanceGraph.map((item) => Number(item.completed_lessons || 0)), 1);
    container.innerHTML = performanceGraph.map((item) => {
        const completed = Number(item.completed_lessons || 0);
        const width = Math.max((completed / maxLessons) * 100, completed > 0 ? 8 : 2);
        return `
            <div class="mb-3">
                <div class="d-flex justify-content-between small mb-1">
                    <span>${tiEscapeHtml(item.name || 'Teacher')}</span>
                    <span>${tiNumber(completed)} lessons</span>
                </div>
                <div class="progress mb-1" style="height: 9px;">
                    <div class="progress-bar bg-primary" style="width: ${width}%"></div>
                </div>
                <div class="small text-muted">
                    Rating ${Number(item.rating || 0).toFixed(1)} | Students ${tiNumber(item.students)} | Upcoming ${tiNumber(item.upcoming_lessons)}
                </div>
            </div>
        `;
    }).join('');
}

function tiRenderTeacherTable(teachers) {
    const tbody = document.getElementById('tiTeachersTable');
    const filteredCount = document.getElementById('tiFilteredCount');
    if (!tbody) return;

    filteredCount.textContent = tiNumber(teachers.length);

    if (!teachers || teachers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">No teachers match this filter.</td></tr>';
        return;
    }

    tbody.innerHTML = teachers.map((teacher) => {
        const metrics = teacher.metrics || {};
        const progressScore = Number(teacher.progress?.score || 0);
        return `
            <tr>
                <td>
                    <div class="fw-semibold">${tiEscapeHtml(teacher.display_name || 'Teacher')}</div>
                    <div class="small text-muted">${tiEscapeHtml(teacher.email || '')}</div>
                </td>
                <td><span class="badge ${tiStatusBadgeClass(teacher.verification_status)}">${tiStatusLabel(teacher.verification_status)}</span></td>
                <td style="min-width: 170px;">
                    <div class="d-flex justify-content-between small mb-1">
                        <span>${progressScore}%</span>
                        <span class="text-muted">${teacher.progress?.completed_steps || 0}/${teacher.progress?.total_steps || 0}</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-info" style="width: ${Math.max(progressScore, 2)}%"></div>
                    </div>
                </td>
                <td>
                    <div class="small">Done: ${tiNumber(metrics.completed_lessons)}</div>
                    <div class="small text-muted">Upcoming: ${tiNumber(metrics.upcoming_lessons)}</div>
                </td>
                <td>${tiNumber(metrics.total_students)}</td>
                <td>${tiNumber(metrics.posts_count)}</td>
                <td>${Number(metrics.avg_rating || 0).toFixed(1)} <span class="text-muted small">(${tiNumber(metrics.total_reviews)})</span></td>
                <td>
                    <span class="badge bg-light text-dark">${tiNumber(metrics.documents_count)} docs</span>
                    <span class="badge bg-secondary">${tiNumber(metrics.certificates_count)} cert</span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" type="button" onclick="selectTeacherForIntelligence('${teacher.id}')">
                        View
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function tiPopulateAiTeacherSelect(teachers) {
    const select = document.getElementById('tiAiTeacherSelect');
    if (!select) return;
    const currentValue = select.value || '';
    const options = ['<option value="">All teachers in current view</option>'];
    teachers.forEach((teacher) => {
        options.push(`<option value="${tiEscapeHtml(teacher.id)}">${tiEscapeHtml(teacher.display_name || 'Teacher')}</option>`);
    });
    select.innerHTML = options.join('');
    if (currentValue && teachers.some((teacher) => teacher.id === currentValue)) {
        select.value = currentValue;
    }
}

function tiRenderTeacherDetail(teacher) {
    const detailContainer = document.getElementById('tiTeacherDetail');
    const timestamp = document.getElementById('tiDetailTimestamp');
    if (!detailContainer) return;
    if (!teacher) {
        detailContainer.innerHTML = '<div class="text-muted">Select a teacher to inspect full application details, certificates, and progress steps.</div>';
        timestamp.textContent = 'No teacher selected';
        return;
    }

    const metrics = teacher.metrics || {};
    const steps = teacher.progress?.steps || {};
    const stepOrder = [
        ['application_submitted', 'Application Submitted'],
        ['profile_completed', 'Profile Information Complete'],
        ['subjects_added', 'Subjects Added'],
        ['qualifications_added', 'Qualifications Added'],
        ['certificates_uploaded', 'Certificates Uploaded'],
        ['media_uploaded', 'Profile Media Uploaded'],
        ['first_lesson_completed', 'First Lesson Completed']
    ];

    const stepsHtml = stepOrder.map(([key, label]) => {
        const done = Boolean(steps[key]);
        return `
            <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                <span>${label}</span>
                <span class="badge ${done ? 'bg-success' : 'bg-secondary'}">${done ? 'Done' : 'Pending'}</span>
            </li>
        `;
    }).join('');

    const docs = teacher.documents || [];
    const docsHtml = docs.length > 0
        ? `
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Title</th>
                            <th>Institution</th>
                            <th>Year</th>
                            <th>File</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${docs.map((doc) => `
                            <tr>
                                <td>${tiEscapeHtml(doc.type || 'document')}</td>
                                <td>${tiEscapeHtml(doc.title || 'Document')}</td>
                                <td>${tiEscapeHtml(doc.institution || '-')}</td>
                                <td>${doc.year || '-'}</td>
                                <td>${doc.url ? `<a href="${tiEscapeHtml(doc.url)}" target="_blank" rel="noopener">Open</a>` : '<span class="text-muted">No file</span>'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `
        : '<div class="text-muted">No documents uploaded yet.</div>';

    const subjects = teacher.subject_names || [];
    const subjectsHtml = subjects.length > 0
        ? subjects.map((subject) => `<span class="badge bg-light text-dark me-1 mb-1">${tiEscapeHtml(subject)}</span>`).join('')
        : '<span class="text-muted">No subjects added</span>';

    detailContainer.innerHTML = `
        <div class="row g-3">
            <div class="col-lg-4">
                <h6 class="mb-1">${tiEscapeHtml(teacher.display_name || 'Teacher')}</h6>
                <div class="small text-muted mb-2">${tiEscapeHtml(teacher.email || '')} | ${tiEscapeHtml(teacher.whatsapp || 'No WhatsApp')}</div>
                <div class="mb-2">
                    <span class="badge ${tiStatusBadgeClass(teacher.verification_status)}" id="tiDetailStatusBadge">${tiStatusLabel(teacher.verification_status)}</span>
                    ${teacher.is_new_application ? '<span class="badge bg-warning text-dark ms-1">New</span>' : ''}
                </div>
                <div class="d-flex gap-2 mb-3" id="tiVerifyActions" data-teacher-id="${teacher.id}">
                    ${teacher.verification_status !== 'approved' ? `
                    <button class="btn btn-success btn-sm" onclick="tiVerifyTeacher('${teacher.id}', 'approve')">
                        <i class="fas fa-check-circle me-1"></i>Approve
                    </button>` : ''}
                    ${teacher.verification_status !== 'rejected' ? `
                    <button class="btn btn-danger btn-sm" onclick="tiShowRejectModal('${teacher.id}')">
                        <i class="fas fa-times-circle me-1"></i>Reject
                    </button>` : ''}
                    ${teacher.verification_status === 'approved' ? '<span class="text-success small align-self-center"><i class="fas fa-check-double me-1"></i>Verified Teacher</span>' : ''}
                    ${teacher.verification_status === 'rejected' ? '<span class="text-danger small align-self-center"><i class="fas fa-ban me-1"></i>Application Rejected</span>' : ''}
                </div>
                <div class="small mb-2">${tiEscapeHtml(teacher.bio || 'No bio provided')}</div>
                <div class="small text-muted mb-2"><strong>Experience:</strong> ${tiEscapeHtml(teacher.experience_description || 'Not provided')}</div>
                <div class="small mb-2"><strong>Subjects:</strong><br>${subjectsHtml}</div>
                <div class="small text-muted"><strong>Application Age:</strong> ${teacher.application_age_days ?? '-'} day(s)</div>
            </div>
            <div class="col-lg-4">
                <h6>Progress (${teacher.progress?.score || 0}%)</h6>
                <div class="progress mb-2" style="height: 10px;">
                    <div class="progress-bar bg-info" style="width: ${Math.max(Number(teacher.progress?.score || 0), 2)}%"></div>
                </div>
                <ul class="list-group list-group-flush small">${stepsHtml}</ul>
            </div>
            <div class="col-lg-4">
                <h6>Performance Metrics</h6>
                <div class="small mb-1"><strong>Total Lessons:</strong> ${tiNumber(metrics.total_lessons)}</div>
                <div class="small mb-1"><strong>Completed Lessons:</strong> ${tiNumber(metrics.completed_lessons)}</div>
                <div class="small mb-1"><strong>Upcoming Lessons:</strong> ${tiNumber(metrics.upcoming_lessons)}</div>
                <div class="small mb-1"><strong>Students:</strong> ${tiNumber(metrics.total_students)}</div>
                <div class="small mb-1"><strong>Posts:</strong> ${tiNumber(metrics.posts_count)}</div>
                <div class="small mb-1"><strong>Rating:</strong> ${Number(metrics.avg_rating || 0).toFixed(1)} (${tiNumber(metrics.total_reviews)} reviews)</div>
                <div class="small mb-1"><strong>Certificates:</strong> ${tiNumber(metrics.certificates_count)}</div>
                <div class="small"><strong>Total Documents:</strong> ${tiNumber(metrics.documents_count)}</div>
            </div>
        </div>
        <hr>
        <h6>Verification Files and Certificates</h6>
        ${docsHtml}
    `;
    timestamp.textContent = `Selected: ${teacher.display_name || 'Teacher'}`;
}

function selectTeacherForIntelligence(teacherId) {
    const teacher = teacherIntelState.teachers.find((row) => row.id === teacherId);
    if (!teacher) return;
    teacherIntelState.selectedTeacherId = teacherId;
    tiRenderTeacherDetail(teacher);
    const aiScope = document.getElementById('tiAiTeacherSelect');
    if (aiScope) {
        aiScope.value = teacherId;
    }
}

function loadTeacherIntelligenceData() {
    const refreshBtn = document.getElementById('tiRefreshBtn');
    const teachersTable = document.getElementById('tiTeachersTable');
    const statusFilter = document.getElementById('tiStatusFilter')?.value || 'all';
    const searchQuery = document.getElementById('tiSearchInput')?.value?.trim() || '';

    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
    }
    if (teachersTable) {
        teachersTable.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading teacher intelligence data...</td></tr>';
    }

    const params = new URLSearchParams();
    params.set('status', statusFilter);
    params.set('q', searchQuery);

    return fetch(`/api/admin/api/teachers/intelligence?${params.toString()}`)
        .then((response) => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then((data) => {
            teacherIntelState.loaded = true;
            teacherIntelState.teachers = data.teachers || [];

            tiRenderSummary(data.summary || {});
            tiRenderStatusGraph(data.status_distribution || []);
            tiRenderPerformanceGraph(data.performance_graph || []);
            tiRenderTeacherTable(teacherIntelState.teachers);
            tiPopulateAiTeacherSelect(teacherIntelState.teachers);

            if (teacherIntelState.selectedTeacherId) {
                const selected = teacherIntelState.teachers.find((teacher) => teacher.id === teacherIntelState.selectedTeacherId);
                if (selected) {
                    tiRenderTeacherDetail(selected);
                } else if (teacherIntelState.teachers.length > 0) {
                    selectTeacherForIntelligence(teacherIntelState.teachers[0].id);
                } else {
                    tiRenderTeacherDetail(null);
                }
            } else if (teacherIntelState.teachers.length > 0) {
                selectTeacherForIntelligence(teacherIntelState.teachers[0].id);
            } else {
                tiRenderTeacherDetail(null);
            }
        })
        .catch((error) => {
            console.error('Error loading teacher intelligence:', error);
            tiRenderTeacherTable([]);
            document.getElementById('tiStatusGraph').innerHTML = '<div class="text-danger small">Failed to load status graph.</div>';
            document.getElementById('tiPerformanceGraph').innerHTML = '<div class="text-danger small">Failed to load performance graph.</div>';
            tiRenderTeacherDetail(null);
        })
        .finally(() => {
            if (refreshBtn) {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh Data';
            }
        });
}

//  Teacher Approve / Reject 
function tiVerifyTeacher(teacherId, action) {
    const confirmMsg = action === 'approve'
        ? 'Are you sure you want to approve this teacher?'
        : 'Are you sure you want to reject this teacher?';

    if (action === 'approve' && !confirm(confirmMsg)) return;

    const actionsDiv = document.getElementById('tiVerifyActions');
    if (actionsDiv) actionsDiv.innerHTML = '<span class="text-info small"><i class="fas fa-spinner fa-spin me-1"></i>Processing...</span>';

    fetch(`/api/admin/api/teachers/${teacherId}/verify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: action, reason: '' })
    })
        .then(res => res.json().then(body => ({ ok: res.ok, body })))
        .then(({ ok, body }) => {
            if (!ok || !body.success) throw new Error(body.error || body.message || 'Action failed');
            // Update the teacher in local state and re-render
            const teacher = teacherIntelState.teachers.find(t => t.id === teacherId);
            if (teacher) {
                teacher.verification_status = body.new_status;
                tiRenderTeacherDetail(teacher);
                tiRenderTeacherTable(teacherIntelState.teachers);
            }
            tiShowAlert('success', body.message);
        })
        .catch(err => {
            console.error('Verification error:', err);
            tiShowAlert('danger', `Failed: ${err.message}`);
            // Re-render to restore buttons
            const teacher = teacherIntelState.teachers.find(t => t.id === teacherId);
            if (teacher) tiRenderTeacherDetail(teacher);
        });
}

function tiShowRejectModal(teacherId) {
    document.getElementById('tiRejectTeacherId').value = teacherId;
    document.getElementById('tiRejectReason').value = '';
    const modal = new bootstrap.Modal(document.getElementById('tiRejectModal'));
    modal.show();
}

function tiConfirmReject() {
    const teacherId = document.getElementById('tiRejectTeacherId').value;
    const reason = document.getElementById('tiRejectReason').value.trim();

    // Close modal
    const modalEl = document.getElementById('tiRejectModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();

    const actionsDiv = document.getElementById('tiVerifyActions');
    if (actionsDiv) actionsDiv.innerHTML = '<span class="text-info small"><i class="fas fa-spinner fa-spin me-1"></i>Processing...</span>';

    fetch(`/api/admin/api/teachers/${teacherId}/verify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'reject', reason: reason })
    })
        .then(res => res.json().then(body => ({ ok: res.ok, body })))
        .then(({ ok, body }) => {
            if (!ok || !body.success) throw new Error(body.error || body.message || 'Rejection failed');
            const teacher = teacherIntelState.teachers.find(t => t.id === teacherId);
            if (teacher) {
                teacher.verification_status = body.new_status;
                tiRenderTeacherDetail(teacher);
                tiRenderTeacherTable(teacherIntelState.teachers);
            }
            tiShowAlert('warning', body.message);
        })
        .catch(err => {
            console.error('Rejection error:', err);
            tiShowAlert('danger', `Failed: ${err.message}`);
            const teacher = teacherIntelState.teachers.find(t => t.id === teacherId);
            if (teacher) tiRenderTeacherDetail(teacher);
        });
}

function tiShowAlert(type, message) {
    const container = document.getElementById('alertContainer') || document.querySelector('.tab-pane.active');
    if (!container) return;
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 420px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => { alertDiv.remove(); }, 5000);
}

//  Teacher AI Chat Interface 
const tiChatHistory = [];

function tiGetTimestamp() {
    return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function tiAppendMessage(role, text, meta) {
    const container = document.getElementById('tiChatMessages');
    const bubble = document.createElement('div');
    bubble.className = `ti-chat-bubble ti-chat-${role}`;

    const icon = role === 'ai' ? 'fa-robot' : 'fa-user-shield';
    const metaText = meta || (role === 'ai' ? 'Vertex AI' : tiGetTimestamp());

    // Format text: convert **bold** and line breaks
    let formattedText = tiEscapeHtml(text)
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');

    bubble.innerHTML = `
        <div class="ti-chat-avatar"><i class="fas ${icon}"></i></div>
        <div class="ti-chat-content">
            <div class="ti-chat-text">${formattedText}</div>
            <div class="ti-chat-meta">${tiEscapeHtml(metaText)}</div>
        </div>
    `;
    container.appendChild(bubble);
    container.scrollTop = container.scrollHeight;
    return bubble;
}

function tiShowTyping() {
    const container = document.getElementById('tiChatMessages');
    const bubble = document.createElement('div');
    bubble.className = 'ti-chat-bubble ti-chat-ai';
    bubble.id = 'tiTypingIndicator';
    bubble.innerHTML = `
        <div class="ti-chat-avatar"><i class="fas fa-robot"></i></div>
        <div class="ti-chat-content">
            <div class="ti-chat-text">
                <div class="ti-chat-typing"><span></span><span></span><span></span></div>
            </div>
        </div>
    `;
    container.appendChild(bubble);
    container.scrollTop = container.scrollHeight;
}

function tiHideTyping() {
    const el = document.getElementById('tiTypingIndicator');
    if (el) el.remove();
}

function tiClearChat() {
    tiChatHistory.length = 0;
    const container = document.getElementById('tiChatMessages');
    container.innerHTML = '';
    // Re-add welcome message
    const welcome = document.createElement('div');
    welcome.className = 'ti-chat-bubble ti-chat-ai';
    welcome.innerHTML = `
        <div class="ti-chat-avatar"><i class="fas fa-robot"></i></div>
        <div class="ti-chat-content">
            <div class="ti-chat-text">Chat cleared. How can I help you with teacher management?</div>
            <div class="ti-chat-meta">Vertex AI &middot; Gemini 2.5 Flash</div>
        </div>
    `;
    container.appendChild(welcome);
}

function tiAutoGrowTextarea() {
    const ta = document.getElementById('tiAiPrompt');
    ta.style.height = 'auto';
    ta.style.height = Math.min(ta.scrollHeight, 80) + 'px';
}

function handleTeacherAiSubmit(e) {
    e.preventDefault();
    const askBtn = document.getElementById('tiAiAskBtn');
    const promptEl = document.getElementById('tiAiPrompt');
    const query = (promptEl?.value || '').trim();
    const teacherId = document.getElementById('tiAiTeacherSelect')?.value || '';
    const status = document.getElementById('tiStatusFilter')?.value || 'all';
    const search = document.getElementById('tiSearchInput')?.value?.trim() || '';

    if (!query) return;

    // Add user message to chat
    tiAppendMessage('user', query);
    tiChatHistory.push({ role: 'user', text: query });

    // Clear input and reset height
    promptEl.value = '';
    promptEl.style.height = 'auto';

    // Disable send button, show typing
    askBtn.disabled = true;
    tiShowTyping();

    fetch('/api/admin/api/teachers/ai-assistant', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query, teacher_id: teacherId, status, search })
    })
        .then((response) => response.json().then((body) => ({ ok: response.ok, body })))
        .then(({ ok, body }) => {
            tiHideTyping();
            if (!ok) throw new Error(body.error || 'AI request failed');
            const modelTag = body.model_used || 'Vertex AI';
            const answer = body.answer || 'No response returned.';
            tiAppendMessage('ai', answer, `${modelTag} &middot; ${tiGetTimestamp()}`);
            tiChatHistory.push({ role: 'ai', text: answer });
        })
        .catch((error) => {
            tiHideTyping();
            console.error('AI assistant error:', error);
            tiAppendMessage('ai', `Sorry, I encountered an error: ${error.message}\n\nPlease try again.`, 'Error');
        })
        .finally(() => {
            askBtn.disabled = false;
            promptEl.focus();
        });
}

// Auto-grow textarea on input
document.addEventListener('DOMContentLoaded', function() {
    const ta = document.getElementById('tiAiPrompt');
    if (ta) ta.addEventListener('input', tiAutoGrowTextarea);
});

// Initialize admin panel
document.addEventListener('DOMContentLoaded', function() {
    console.log('Admin panel DOM loaded, initializing...');
    
    // Check if required elements exist
    const requiredElements = [
        'pendingPaymentsContent',
        'approvedPaymentsContent', 
        'rejectedPaymentsContent',
        'pendingPayments',
        'totalRevenue',
        'approvedPayments',
        'rejectedPayments'
    ];
    
    const missingElements = requiredElements.filter(id => !document.getElementById(id));
    if (missingElements.length > 0) {
        console.error('Missing required elements:', missingElements);
    } else {
        console.log('All required elements found');
    }
    
    loadPaymentStats();
    loadSystemSettings();
    loadCreditStatistics();
    loadBroadcastHistory();
    
    // Setup subject change handler
    document.getElementById('questionSubject').addEventListener('change', updateTopics);
    
    // Setup bulk target change handler
    document.getElementById('bulkTarget').addEventListener('change', handleBulkTargetChange);
    
    // Setup form handlers
    document.getElementById('creditForm').addEventListener('submit', handleCreditForm);
    document.getElementById('resetCreditForm').addEventListener('submit', handleResetCreditForm);
    document.getElementById('bulkCreditForm').addEventListener('submit', handleBulkCreditForm);
    document.getElementById('questionForm').addEventListener('submit', handleQuestionForm);
    document.getElementById('settingsForm').addEventListener('submit', handleSettingsForm);
    document.getElementById('broadcastForm').addEventListener('submit', handleBroadcastForm);
    document.getElementById('tiAiForm').addEventListener('submit', handleTeacherAiSubmit);

    const teacherTab = document.getElementById('teachers-intelligence-tab');
    if (teacherTab) {
        teacherTab.addEventListener('shown.bs.tab', function() {
            if (!teacherIntelState.loaded) {
                loadTeacherIntelligenceData();
            }
        });
    }
    document.getElementById('tiRefreshBtn').addEventListener('click', loadTeacherIntelligenceData);
    document.getElementById('tiStatusFilter').addEventListener('change', loadTeacherIntelligenceData);
    document.getElementById('tiSearchInput').addEventListener('input', function() {
        if (teacherSearchDebounce) clearTimeout(teacherSearchDebounce);
        teacherSearchDebounce = setTimeout(loadTeacherIntelligenceData, 350);
    });
    
    // Auto-refresh credit statistics every 30 seconds
    setInterval(loadCreditStatistics, 30000);
    
    // Auto-refresh broadcast history every 60 seconds
    setInterval(loadBroadcastHistory, 60000);
});

function updateTopics() {
    const subjectSelect = document.getElementById('questionSubject');
    const topicSelect = document.getElementById('questionTopic');
    const subject = subjectSelect.value;
    
    topicSelect.innerHTML = '<option value="">Select topic</option>';
    
    if (subject && TOPICS[subject]) {
        TOPICS[subject].forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            option.textContent = topic;
            topicSelect.appendChild(option);
        });
    }
}

function searchUsers() {
    const query = document.getElementById('userSearch').value.trim();
    const searchType = document.getElementById('searchType').value;
    
    if (!query) {
        alert('Please enter a search query');
        return;
    }
    
    const tableBody = document.getElementById('usersTable');
    tableBody.innerHTML = '<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Searching...</td></tr>';
    
    fetch(`/api/admin/api/users/search?q=${encodeURIComponent(query)}&type=${searchType}`)
        .then(response => response.json())
        .then(data => {
            if (data.users && data.users.length > 0) {
                displayUsers(data.users);
            } else {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No users found</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error searching users:', error);
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error searching users</td></tr>';
        });
}

function displayUsers(users) {
    const tableBody = document.getElementById('usersTable');
    
    tableBody.innerHTML = users.map(user => `
        <tr>
            <td>${user.nerdx_id || 'N/A'}</td>
            <td>${user.name || 'N/A'} ${user.surname || ''}</td>
            <td>${user.credits || 0}</td>
            <td>${user.total_points || 0}</td>
            <td>${user.streak_count || 0}</td>
            <td>
                <span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">
                    ${user.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary me-1" onclick="viewUserDetails('${user.whatsapp_id}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-warning me-1" onclick="editCredits('${user.whatsapp_id}')">
                    <i class="fas fa-coins"></i>
                </button>
                <button class="btn btn-sm btn-secondary" onclick="toggleUserStatus('${user.whatsapp_id}', ${!user.is_active})">
                    <i class="fas fa-${user.is_active ? 'ban' : 'check'}"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function handleCreditForm(e) {
    e.preventDefault();
    
    const userId = document.getElementById('creditUserId').value;
    const action = document.getElementById('creditAction').value;
    const amount = parseInt(document.getElementById('creditAmount').value);
    const reason = document.getElementById('creditReason').value;
    
    if (!userId || !action || !amount || !reason) {
        alert('Please fill all fields');
        return;
    }
    
    fetch(`/api/admin/api/users/${userId}/credits`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: action,
            amount: amount,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById('creditForm').reset();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error managing credits:', error);
        alert('Error processing credit operation');
    });
}

function handleQuestionForm(e) {
    e.preventDefault();
    
    const subject = document.getElementById('questionSubject').value;
    const topic = document.getElementById('questionTopic').value;
    const difficulty = document.getElementById('questionDifficulty').value;
    const count = parseInt(document.getElementById('questionCount').value);
    
    if (!subject || !topic || !difficulty || !count) {
        alert('Please fill all fields');
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
    
    fetch('/api/admin/api/questions/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            subject: subject,
            topic: topic,
            difficulty: difficulty,
            count: count
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayGeneratedQuestions(data.questions);
            alert(`Successfully generated ${data.generated} out of ${data.requested} questions`);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error generating questions:', error);
        alert('Error generating questions');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-magic me-1"></i>Generate Questions';
    });
}

function displayGeneratedQuestions(questions) {
    const container = document.getElementById('generatedQuestions');
    
    if (!questions || questions.length === 0) {
        container.innerHTML = '<p class="text-muted">No questions generated</p>';
        return;
    }
    
    container.innerHTML = questions.map(q => `
        <div class="card mb-2">
            <div class="card-body">
                <h6 class="card-title">${q.subject} - ${q.topic}</h6>
                <p class="card-text">${q.question}</p>
                <small class="text-muted">Difficulty: ${q.difficulty} | Points: ${q.points}</small>
            </div>
        </div>
    `).join('');
}

function loadPaymentStats() {
    fetch('/api/admin/api/payments/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalRevenue').textContent = `$${data.total_revenue || 0}`;
            document.getElementById('totalTransactions').textContent = data.total_transactions || 0;
            document.getElementById('successfulPayments').textContent = data.successful_payments || 0;
            document.getElementById('failedPayments').textContent = data.failed_transactions || 0;
        })
        .catch(error => {
            console.error('Error loading payment stats:', error);
        });
}

function loadSystemSettings() {
    fetch('/api/admin/api/system/settings')
        .then(response => response.json())
        .then(data => {
            // Load credit costs
            document.getElementById('mathEasy').value = data.credit_costs?.math_easy || 5;
            document.getElementById('mathMedium').value = data.credit_costs?.math_medium || 10;
            document.getElementById('mathDifficult').value = data.credit_costs?.math_difficult || 20;
            document.getElementById('scienceEasy').value = data.credit_costs?.science_easy || 5;
            document.getElementById('scienceMedium').value = data.credit_costs?.science_medium || 10;
            document.getElementById('scienceDifficult').value = data.credit_costs?.science_difficult || 15;
            
            // Load rate limits
            document.getElementById('sessionCooldown').value = data.rate_limits?.session_cooldown || 30;
            document.getElementById('generationTimeout').value = data.rate_limits?.generation_timeout || 120;
            
            // Load bonuses
            document.getElementById('welcomeCredits').value = data.welcome_credits || 50;
            document.getElementById('referrerBonus').value = data.referral_credits?.referrer_bonus || 25;
            document.getElementById('newUserBonus').value = data.referral_credits?.new_user_bonus || 15;
        })
        .catch(error => {
            console.error('Error loading system settings:', error);
        });
}

function handleSettingsForm(e) {
    e.preventDefault();
    
    const settings = {
        credit_costs: {
            math_easy: parseInt(document.getElementById('mathEasy').value),
            math_medium: parseInt(document.getElementById('mathMedium').value),
            math_difficult: parseInt(document.getElementById('mathDifficult').value),
            science_easy: parseInt(document.getElementById('scienceEasy').value),
            science_medium: parseInt(document.getElementById('scienceMedium').value),
            science_difficult: parseInt(document.getElementById('scienceDifficult').value)
        },
        rate_limits: {
            session_cooldown: parseInt(document.getElementById('sessionCooldown').value),
            generation_timeout: parseInt(document.getElementById('generationTimeout').value)
        },
        welcome_credits: parseInt(document.getElementById('welcomeCredits').value),
        referral_credits: {
            referrer_bonus: parseInt(document.getElementById('referrerBonus').value),
            new_user_bonus: parseInt(document.getElementById('newUserBonus').value)
        }
    };
    
    fetch('/api/admin/api/system/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Settings saved successfully');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving settings:', error);
        alert('Error saving settings');
    });
}

function handleBroadcastForm(e) {
    e.preventDefault();
    
    const target = document.getElementById('broadcastTarget').value;
    const message = document.getElementById('broadcastMessage').value.trim();
    
    if (!message) {
        alert('Please enter a message');
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    if (confirm(`Send broadcast to ${target} users?`)) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
        
        fetch('/api/admin/api/broadcast', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                target: target,
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${data.message}\n\nSent to: ${data.successful_sends} users\nFailed: ${data.failed_sends} users`);
                document.getElementById('broadcastForm').reset();
                loadBroadcastHistory(); // Refresh history
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error sending broadcast:', error);
            alert('Error sending broadcast');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    }
}

function loadBroadcastHistory() {
    fetch('/api/admin/api/broadcast/history')
        .then(response => response.json())
        .then(data => {
            displayBroadcastHistory(data.broadcasts || []);
        })
        .catch(error => {
            console.error('Error loading broadcast history:', error);
            document.getElementById('broadcastHistory').innerHTML = '<p class="text-danger text-center">Error loading broadcast history</p>';
        });
}

function displayBroadcastHistory(broadcasts) {
    const container = document.getElementById('broadcastHistory');
    
    if (broadcasts.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No broadcasts sent yet</p>';
        return;
    }
    
    container.innerHTML = broadcasts.map(broadcast => {
        const date = new Date(broadcast.created_at).toLocaleString();
        const successRate = broadcast.success_rate;
        const statusColor = successRate >= 90 ? 'text-success' : successRate >= 70 ? 'text-warning' : 'text-danger';
        
        return `
            <div class="border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="fw-bold">${broadcast.target_group.toUpperCase()}</div>
                        <div class="text-muted small">${broadcast.message}</div>
                        <div class="small text-secondary">${date}</div>
                    </div>
                    <div class="text-end ms-2">
                        <div class="${statusColor} fw-bold">${successRate}%</div>
                        <div class="small text-muted">
                            ${broadcast.successful_sends}/${broadcast.total_recipients}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function viewUserDetails(userId) {
    const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
    modal.show();
    
    fetch(`/api/dashboard/api/user/${userId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('userDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <p><strong>Credits:</strong> ${data.credits || 0}</p>
                        <p><strong>Total Points:</strong> ${data.total_points || 0}</p>
                        <p><strong>Current Streak:</strong> ${data.streak_count || 0} days</p>
                        <p><strong>Level:</strong> ${data.level?.name || 'Unknown'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Activity</h6>
                        <p><strong>Questions Answered:</strong> ${data.questions_answered || 0}</p>
                        <p><strong>Accuracy:</strong> ${data.accuracy || 0}%</p>
                        <p><strong>Last Activity:</strong> ${data.last_activity || 'Never'}</p>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            document.getElementById('userDetailsContent').innerHTML = '<p class="text-danger">Error loading user details</p>';
        });
}

function editCredits(userId) {
    document.getElementById('creditUserId').value = userId;
    document.querySelector('[href="#credits"]').click();
}

function exportUsers() {
    fetch('/admin/api/export/users')
        .then(response => response.json())
        .then(data => {
            alert(data.message || 'Export started');
        })
        .catch(error => {
            console.error('Error exporting users:', error);
            alert('Error starting export');
        });
}

// ================================
// CREDIT MANAGEMENT FUNCTIONS
// ================================

function loadCreditStatistics() {
    fetch('/api/admin/api/credits/statistics')
        .then(response => response.json())
        .then(data => {
            if (data.overview) {
                // Update statistics cards
                document.getElementById('totalUsers').textContent = data.overview.total_users.toLocaleString();
                document.getElementById('totalCredits').textContent = data.overview.total_credits.toLocaleString();
                document.getElementById('avgCredits').textContent = data.overview.avg_credits.toLocaleString();
                document.getElementById('lowCreditUsers').textContent = data.overview.low_credit_users.toLocaleString();
                
                // Update top users list
                displayTopUsers(data.top_users || []);
                
                // Update recent transactions
                displayRecentTransactions(data.recent_transactions || []);
            }
        })
        .catch(error => {
            console.error('Error loading credit statistics:', error);
        });
}

function displayTopUsers(users) {
    const container = document.getElementById('topUsersList');
    
    if (users.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No users found</p>';
        return;
    }
    
    container.innerHTML = users.map((user, index) => `
        <div class="d-flex justify-content-between align-items-center mb-2 p-2 ${index < 3 ? 'bg-light rounded' : ''}">
            <div>
                <div class="fw-bold">
                    ${index < 3 ? ['', '', ''][index] : `${index + 1}.`}
                    ${user.username}
                </div>
                <small class="text-muted">${user.user_id.slice(-8)}</small>
            </div>
            <div class="text-end">
                <div class="fw-bold text-success">${user.credits.toLocaleString()}</div>
                <small class="text-muted">credits</small>
            </div>
        </div>
    `).join('');
}

function displayRecentTransactions(transactions) {
    const container = document.getElementById('recentTransactions');
    
    if (transactions.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No recent transactions</p>';
        return;
    }
    
    container.innerHTML = transactions.map(tx => {
        const date = new Date(tx.date).toLocaleString();
        const typeColor = tx.credits_used > 0 ? 'text-danger' : 'text-success';
        const typeIcon = tx.credits_used > 0 ? 'fa-minus' : 'fa-plus';
        
        return `
            <div class="border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="fw-bold">${tx.user_id.slice(-8)}</div>
                        <small class="text-muted">${tx.type}</small>
                    </div>
                    <div class="text-end">
                        <div class="${typeColor}">
                            <i class="fas ${typeIcon}"></i> ${Math.abs(tx.credits_used)}
                        </div>
                        <small class="text-muted">${date}</small>
                    </div>
                </div>
                <small class="text-muted d-block">${tx.description}</small>
            </div>
        `;
    }).join('');
}

function handleBulkTargetChange() {
    const target = document.getElementById('bulkTarget').value;
    const specificDiv = document.getElementById('specificUsersDiv');
    
    if (target === 'specific_users') {
        specificDiv.style.display = 'block';
    } else {
        specificDiv.style.display = 'none';
    }
}

function handleResetCreditForm(e) {
    e.preventDefault();
    
    const userId = document.getElementById('resetUserId').value.trim();
    const amount = parseInt(document.getElementById('resetAmount').value);
    const reason = document.getElementById('resetReason').value.trim();
    
    if (!userId || !amount || !reason) {
        alert('Please fill all fields');
        return;
    }
    
    if (!confirm(`Reset user ${userId} credits to ${amount}? This action cannot be undone.`)) {
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Resetting...';
    
    fetch('/api/admin/api/credits/reset-user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user_id: userId,
            amount: amount,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById('resetCreditForm').reset();
            loadCreditStatistics(); // Refresh stats
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error resetting credits:', error);
        alert('Error resetting user credits');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function handleBulkCreditForm(e) {
    e.preventDefault();
    
    const target = document.getElementById('bulkTarget').value;
    const amount = parseInt(document.getElementById('bulkAmount').value);
    const reason = document.getElementById('bulkReason').value.trim();
    let userIds = [];
    
    if (target === 'specific_users') {
        const userIdsText = document.getElementById('specificUserIds').value.trim();
        if (!userIdsText) {
            alert('Please enter user IDs for specific users option');
            return;
        }
        userIds = userIdsText.split(',').map(id => id.trim()).filter(id => id);
        if (userIds.length === 0) {
            alert('Please enter valid user IDs');
            return;
        }
    }
    
    if (!target || !amount || !reason) {
        alert('Please fill all required fields');
        return;
    }
    
    const targetText = target === 'all' ? 'all users' : 
                     target === 'low_credits' ? 'users with low credits' : 
                     `${userIds.length} specific users`;
    
    if (!confirm(`Add ${amount} credits to ${targetText}? This will send ${amount} credits to each user.`)) {
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
    
    fetch('/api/admin/api/credits/bulk-refresh', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            target: target,
            amount: amount,
            reason: reason,
            user_ids: userIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showBulkResults(data);
            document.getElementById('bulkCreditForm').reset();
            handleBulkTargetChange(); // Reset visibility
            loadCreditStatistics(); // Refresh stats
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error bulk refreshing credits:', error);
        alert('Error processing bulk credit operation');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function quickBulkCredits(amount, target) {
    const targetText = target === 'all' ? 'all users' : 'users with low credits';
    
    if (!confirm(`Give ${amount} credits to ${targetText}?`)) {
        return;
    }
    
    fetch('/api/admin/api/credits/bulk-refresh', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            target: target,
            amount: amount,
            reason: `Quick admin credit boost - ${amount} credits`,
            user_ids: []
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showBulkResults(data);
            loadCreditStatistics(); // Refresh stats
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error in quick bulk credits:', error);
        alert('Error processing quick credit operation');
    });
}

function showBulkResults(data) {
    const modal = new bootstrap.Modal(document.getElementById('bulkResultModal'));
    const content = document.getElementById('bulkResultContent');
    
    content.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Bulk Operation Completed</h6>
            <p class="mb-0">${data.message}</p>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h4 text-success">${data.successful_updates}</div>
                    <small class="text-muted">Successful</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h4 text-danger">${data.failed_updates}</div>
                    <small class="text-muted">Failed</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h4 text-primary">${data.total_users}</div>
                    <small class="text-muted">Total Users</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h4 text-warning">${data.credits_added}</div>
                    <small class="text-muted">Credits Added</small>
                </div>
            </div>
        </div>
        
        ${data.updated_users && data.updated_users.length > 0 ? `
            <h6>Sample Updated Users:</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Before</th>
                            <th>After</th>
                            <th>Added</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.updated_users.map(user => `
                            <tr>
                                <td>${user.username} <small class="text-muted">(${user.user_id.slice(-8)})</small></td>
                                <td>${user.credits_before.toLocaleString()}</td>
                                <td class="text-success fw-bold">${user.credits_after.toLocaleString()}</td>
                                <td class="text-primary">+${user.credits_added}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            ${data.updated_users.length < data.successful_updates ? `
                <small class="text-muted">Showing first ${data.updated_users.length} of ${data.successful_updates} updated users</small>
            ` : ''}
        ` : ''}
    `;
    
    modal.show();
}

// ========================================
// PAYMENT MANAGEMENT FUNCTIONS
// ========================================

// Load payment statistics
function loadPaymentStats() {
    fetch('/admin/payments/api/stats')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const pendingElement = document.getElementById('pendingPayments');
            const revenueElement = document.getElementById('totalRevenue');
            const approvedElement = document.getElementById('approvedPayments');
            const rejectedElement = document.getElementById('rejectedPayments');
            
            if (pendingElement) pendingElement.textContent = data.pending_count || 0;
            if (revenueElement) revenueElement.textContent = data.total_revenue || '$0.00';
            if (approvedElement) approvedElement.textContent = data.approved_count || 0;
            if (rejectedElement) rejectedElement.textContent = data.rejected_count || 0;
            
            // Update pending badge
            const pendingBadge = document.getElementById('pendingBadge');
            if (pendingBadge) {
                pendingBadge.textContent = data.pending_count || 0;
                if (data.pending_count > 0) {
                    pendingBadge.className = 'badge bg-warning ms-1';
                } else {
                    pendingBadge.className = 'badge bg-secondary ms-1';
                }
            }
        })
        .catch(error => {
            console.error('Error loading payment stats:', error);
        });
}

// Load pending payments
function loadPendingPayments() {
    const container = document.getElementById('pendingPaymentsContent');
    if (!container) {
        console.error('Element with id "pendingPaymentsContent" not found');
        return;
    }
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Loading pending payments...</p>
        </div>
    `;
    
    fetch('/admin/payments/api/pending')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            displayPendingPayments(data);
        })
        .catch(error => {
            console.error('Error loading pending payments:', error);
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading pending payments: ${error.message}
                        <br><small>Please check the console for more details.</small>
                    </div>
                `;
            }
        });
}

// Display pending payments
function displayPendingPayments(payments) {
    const container = document.getElementById('pendingPaymentsContent');
    
    if (!container) {
        console.error('Element with id "pendingPaymentsContent" not found');
        return;
    }
    
    if (!payments || payments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                <p>No pending payments to approve</p>
                <small>All payments have been processed</small>
            </div>
        `;
        return;
    }
    
    container.innerHTML = payments.map(payment => `
        <div class="card mb-3 border-warning">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="card-title mb-1">
                                    <i class="fas fa-user me-2"></i>
                                    ${payment.user_name} ${payment.user_surname}
                                </h6>
                                <small class="text-muted">
                                    <i class="fas fa-phone me-1"></i>
                                    ${payment.user_id}
                                </small>
                            </div>
                            <span class="badge bg-warning">Pending Approval</span>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-md-4">
                                <strong>Package:</strong> ${payment.package_name}
                            </div>
                            <div class="col-md-4">
                                <strong>Amount:</strong> ${payment.formatted_amount}
                            </div>
                            <div class="col-md-4">
                                <strong>Credits:</strong> ${payment.credits}
                            </div>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <strong>Reference:</strong> <code>${payment.reference_code}</code>
                            </div>
                            <div class="col-md-6">
                                <strong>Submitted:</strong> ${payment.time_ago}
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <strong>Payment Proof:</strong>
                            <div class="bg-light p-2 rounded mt-1">
                                <small>${payment.payment_proof}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-sm" onclick="approvePayment('${payment.reference_code}')">
                                <i class="fas fa-check me-1"></i>
                                Approve Payment
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectPayment('${payment.reference_code}')">
                                <i class="fas fa-times me-1"></i>
                                Reject Payment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Approve payment
function approvePayment(referenceCode) {
    const adminNotes = prompt('Enter admin notes (optional):');
    
    if (adminNotes === null) return; // User cancelled
    
    const approveBtn = event.target;
    const originalText = approveBtn.innerHTML;
    approveBtn.disabled = true;
    approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Approving...';
    
    fetch(`/api/admin/payments/approve/${referenceCode}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `admin_notes=${encodeURIComponent(adminNotes)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', `Payment ${referenceCode} approved successfully! ${data.credits} credits added to user account.`);
            loadPaymentStats(); // Refresh stats
            loadPendingPayments(); // Refresh pending payments
        } else {
            showAlert('danger', `Failed to approve payment: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error approving payment:', error);
        showAlert('danger', 'Error approving payment. Please try again.');
    })
    .finally(() => {
        approveBtn.disabled = false;
        approveBtn.innerHTML = originalText;
    });
}

// Reject payment
function rejectPayment(referenceCode) {
    const adminNotes = prompt('Enter rejection reason (required):');
    
    if (!adminNotes || adminNotes.trim() === '') {
        alert('Please provide a rejection reason');
        return;
    }
    
    const rejectBtn = event.target;
    const originalText = rejectBtn.innerHTML;
    rejectBtn.disabled = true;
    rejectBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Rejecting...';
    
    fetch(`/api/admin/payments/reject/${referenceCode}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `admin_notes=${encodeURIComponent(adminNotes)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', `Payment ${referenceCode} rejected successfully. User will be notified.`);
            loadPaymentStats(); // Refresh stats
            loadPendingPayments(); // Refresh pending payments
        } else {
            showAlert('danger', `Failed to reject payment: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error rejecting payment:', error);
        showAlert('danger', 'Error rejecting payment. Please try again.');
    })
    .finally(() => {
        rejectBtn.disabled = false;
        rejectBtn.innerHTML = originalText;
    });
}

// Load approved payments
function loadApprovedPayments() {
    const container = document.getElementById('approvedPaymentsContent');
    if (!container) {
        console.error('Element with id "approvedPaymentsContent" not found');
        return;
    }
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Loading approved payments...</p>
        </div>
    `;
    
    fetch('/admin/payments/api/approved')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            displayApprovedPayments(data);
        })
        .catch(error => {
            console.error('Error loading approved payments:', error);
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading approved payments: ${error.message}
                        <br><small>Please check the console for more details.</small>
                    </div>
                `;
            }
        });
}

// Display approved payments
function displayApprovedPayments(payments) {
    const container = document.getElementById('approvedPaymentsContent');
    
    if (!container) {
        console.error('Element with id "approvedPaymentsContent" not found');
        return;
    }
    
    if (!payments || payments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-2 text-info"></i>
                <p>No approved payments in the last 30 days</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Package</th>
                        <th>Amount</th>
                        <th>Credits</th>
                        <th>Reference</th>
                        <th>Approved</th>
                    </tr>
                </thead>
                <tbody>
                    ${payments.map(payment => `
                        <tr>
                            <td>
                                <div>
                                    <strong>${payment.user_name} ${payment.user_surname}</strong>
                                    <br><small class="text-muted">${payment.user_id}</small>
                                </div>
                            </td>
                            <td>${payment.package_name}</td>
                            <td>${payment.formatted_amount}</td>
                            <td><span class="badge bg-success">${payment.credits}</span></td>
                            <td><code>${payment.reference_code}</code></td>
                            <td>
                                <small>${payment.time_ago}</small>
                                <br><small class="text-muted">${payment.formatted_approved_at}</small>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Load rejected payments
function loadRejectedPayments() {
    const container = document.getElementById('rejectedPaymentsContent');
    if (!container) {
        console.error('Element with id "rejectedPaymentsContent" not found');
        return;
    }
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Loading rejected payments...</p>
        </div>
    `;
    
    fetch('/admin/payments/api/rejected')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            displayRejectedPayments(data);
        })
        .catch(error => {
            console.error('Error loading rejected payments:', error);
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading rejected payments: ${error.message}
                        <br><small>Please check the console for more details.</small>
                    </div>
                `;
            }
        });
}

// Display rejected payments
function displayRejectedPayments(payments) {
    const container = document.getElementById('rejectedPaymentsContent');
    
    if (!container) {
        console.error('Element with id "rejectedPaymentsContent" not found');
        return;
    }
    
    if (!payments || payments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-2 text-info"></i>
                <p>No rejected payments in the last 30 days</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Package</th>
                        <th>Amount</th>
                        <th>Credits</th>
                        <th>Reference</th>
                        <th>Rejected</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody>
                    ${payments.map(payment => `
                        <tr>
                            <td>
                                <div>
                                    <strong>${payment.user_name} ${payment.user_surname}</strong>
                                    <br><small class="text-muted">${payment.user_id}</small>
                                </div>
                            </td>
                            <td>${payment.package_name}</td>
                            <td>${payment.formatted_amount}</td>
                            <td><span class="badge bg-secondary">${payment.credits}</span></td>
                            <td><code>${payment.reference_code}</code></td>
                            <td>
                                <small>${payment.time_ago}</small>
                                <br><small class="text-muted">${payment.formatted_rejected_at}</small>
                            </td>
                            <td>
                                <small class="text-muted">${payment.admin_notes || 'No reason provided'}</small>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Refresh functions
function refreshPendingPayments() {
    loadPendingPayments();
}

function refreshApprovedPayments() {
    loadApprovedPayments();
}

function refreshRejectedPayments() {
    loadRejectedPayments();
}

// Show alert function
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the payments tab
    const paymentsTab = document.getElementById('payments');
    paymentsTab.insertBefore(alertDiv, paymentsTab.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Initialize payment dashboard when tab is shown
document.addEventListener('DOMContentLoaded', function() {
    // Load payment stats when payments tab is clicked
    const paymentsTab = document.getElementById('payments-tab');
    paymentsTab.addEventListener('click', function() {
        loadPaymentStats();
        loadPendingPayments();
    });
    
    // Load approved payments when approved tab is clicked
    const approvedTab = document.getElementById('approved-tab');
    approvedTab.addEventListener('click', function() {
        loadApprovedPayments();
    });
    
    // Load rejected payments when rejected tab is clicked
    const rejectedTab = document.getElementById('rejected-tab');
    rejectedTab.addEventListener('click', function() {
        loadRejectedPayments();
    });
    // Activate tab from URL hash (e.g. #teachers-intelligence)
    const hash = window.location.hash.replace('#', '');
    if (hash) {
        const tabBtn = document.getElementById(hash + '-tab');
        if (tabBtn) {
            const tab = new bootstrap.Tab(tabBtn);
            tab.show();
        }
    }
});
</script>
{% endblock %}
