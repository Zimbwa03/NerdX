{% extends "base.html" %}

{% block title %}Admin Panel - NerdX Quiz Bot{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h3 mb-0">
            <i class="fas fa-cog me-2"></i>
            Admin Panel
        </h1>
        <p class="text-muted">Manage users, credits, and system settings</p>
    </div>
</div>

<!-- Admin Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
            <i class="fas fa-users me-1"></i>
            User Management
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="credits-tab" data-bs-toggle="tab" data-bs-target="#credits" type="button" role="tab">
            <i class="fas fa-coins me-1"></i>
            Credit Management
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button" role="tab">
            <i class="fas fa-question-circle me-1"></i>
            Question Generation
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">
            <i class="fas fa-credit-card me-1"></i>
            Payments
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
            <i class="fas fa-sliders-h me-1"></i>
            Settings
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="adminTabContent">
    <!-- User Management Tab -->
    <div class="tab-pane fade show active" id="users" role="tabpanel">
        <div class="row mb-3">
            <div class="col-md-8">
                <div class="input-group">
                    <input type="text" class="form-control" id="userSearch" placeholder="Search users by name, NerdX ID, or WhatsApp ID">
                    <select class="form-select" id="searchType" style="max-width: 150px;">
                        <option value="name">Name</option>
                        <option value="nerdx_id">NerdX ID</option>
                        <option value="whatsapp_id">WhatsApp ID</option>
                    </select>
                    <button class="btn btn-primary" onclick="searchUsers()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-success" onclick="exportUsers()">
                    <i class="fas fa-download me-1"></i>
                    Export Users
                </button>
            </div>
        </div>

        <!-- Users Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>NerdX ID</th>
                                <th>Name</th>
                                <th>Credits</th>
                                <th>Points</th>
                                <th>Streak</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="fas fa-search me-2"></i>
                                    Search for users to display results
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Credit Management Tab -->
    <div class="tab-pane fade" id="credits" role="tabpanel">
        <!-- Credit Statistics Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="h4 mb-0" id="totalUsers">-</div>
                                <div class="small">Total Users</div>
                            </div>
                            <div class="fa-2x">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="h4 mb-0" id="totalCredits">-</div>
                                <div class="small">Total Credits</div>
                            </div>
                            <div class="fa-2x">
                                <i class="fas fa-coins"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="h4 mb-0" id="avgCredits">-</div>
                                <div class="small">Avg Credits</div>
                            </div>
                            <div class="fa-2x">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="h4 mb-0" id="lowCreditUsers">-</div>
                                <div class="small">Low Credit Users</div>
                            </div>
                            <div class="fa-2x">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Individual Credit Management -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-user-edit me-2"></i>
                            Individual Credit Management
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="creditForm">
                            <div class="mb-3">
                                <label for="creditUserId" class="form-label">User ID (WhatsApp ID)</label>
                                <input type="text" class="form-control" id="creditUserId" required>
                            </div>
                            <div class="mb-3">
                                <label for="creditAction" class="form-label">Action</label>
                                <select class="form-select" id="creditAction" required>
                                    <option value="">Select action</option>
                                    <option value="add">Add Credits</option>
                                    <option value="deduct">Deduct Credits</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="creditAmount" class="form-label">Amount</label>
                                <input type="number" class="form-control" id="creditAmount" min="1" max="10000" required>
                            </div>
                            <div class="mb-3">
                                <label for="creditReason" class="form-label">Reason</label>
                                <input type="text" class="form-control" id="creditReason" placeholder="e.g., admin adjustment, bonus" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-coins me-1"></i>
                                Process Credits
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Credit Reset Section -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-redo me-2"></i>
                            Reset User Credits
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="resetCreditForm">
                            <div class="mb-3">
                                <label for="resetUserId" class="form-label">User ID</label>
                                <input type="text" class="form-control" id="resetUserId" required>
                            </div>
                            <div class="mb-3">
                                <label for="resetAmount" class="form-label">New Credit Amount</label>
                                <input type="number" class="form-control" id="resetAmount" value="1000" min="0" max="50000" required>
                            </div>
                            <div class="mb-3">
                                <label for="resetReason" class="form-label">Reason</label>
                                <input type="text" class="form-control" id="resetReason" value="Admin credit reset" required>
                            </div>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-redo me-1"></i>
                                Reset Credits
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Bulk Credit Operations -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-users-cog me-2"></i>
                            Bulk Credit Operations
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="bulkCreditForm">
                            <div class="mb-3">
                                <label for="bulkTarget" class="form-label">Target Group</label>
                                <select class="form-select" id="bulkTarget" required>
                                    <option value="all">All Users</option>
                                    <option value="low_credits">Low Credit Users (&lt;50)</option>
                                    <option value="specific_users">Specific Users</option>
                                </select>
                            </div>
                            <div class="mb-3" id="specificUsersDiv" style="display: none;">
                                <label for="specificUserIds" class="form-label">User IDs (comma-separated)</label>
                                <textarea class="form-control" id="specificUserIds" rows="3" placeholder="user1, user2, user3..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="bulkAmount" class="form-label">Credits to Add</label>
                                <input type="number" class="form-control" id="bulkAmount" value="500" min="1" max="10000" required>
                            </div>
                            <div class="mb-3">
                                <label for="bulkReason" class="form-label">Reason</label>
                                <input type="text" class="form-control" id="bulkReason" value="Admin bulk credit refresh" required>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-magic me-1"></i>
                                Refresh Credits
                            </button>
                        </form>

                        <!-- Quick Actions -->
                        <hr>
                        <h6>Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="quickBulkCredits(500, 'all')">
                                <i class="fas fa-plus"></i> Give All Users +500 Credits
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="quickBulkCredits(1000, 'low_credits')">
                                <i class="fas fa-battery-quarter"></i> Help Low Credit Users (+1000)
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="quickBulkCredits(2000, 'all')">
                                <i class="fas fa-gift"></i> MEGA Credits for Everyone (+2000)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Credit Statistics & Top Users -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-trophy me-2"></i>
                            Top Users by Credits
                        </h6>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="topUsersList">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <small class="d-block mt-2">Loading...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>
                            Recent Credit Transactions
                        </h6>
                    </div>
                    <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                        <div id="recentTransactions">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <small class="d-block mt-2">Loading...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Operation Results Modal -->
        <div class="modal fade" id="bulkResultModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Bulk Operation Results</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="bulkResultContent">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Generation Tab -->
    <div class="tab-pane fade" id="questions" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-plus me-2"></i>
                            Generate Questions
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="questionForm">
                            <div class="mb-3">
                                <label for="questionSubject" class="form-label">Subject</label>
                                <select class="form-select" id="questionSubject" required>
                                    <option value="">Select subject</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Biology">Biology</option>
                                    <option value="Chemistry">Chemistry</option>
                                    <option value="Physics">Physics</option>
                                    <option value="English">English</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="questionTopic" class="form-label">Topic</label>
                                <select class="form-select" id="questionTopic" required>
                                    <option value="">Select topic</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="questionDifficulty" class="form-label">Difficulty</label>
                                <select class="form-select" id="questionDifficulty" required>
                                    <option value="">Select difficulty</option>
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="difficult">Difficult</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="questionCount" class="form-label">Number of Questions</label>
                                <input type="number" class="form-control" id="questionCount" min="1" max="10" value="1" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-magic me-1"></i>
                                Generate Questions
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            Generated Questions
                        </h6>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="generatedQuestions">
                            <p class="text-muted text-center">
                                <i class="fas fa-lightbulb me-2"></i>
                                Generated questions will appear here
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payments Tab -->
    <div class="tab-pane fade" id="payments" role="tabpanel">
        <div class="row mb-3">
            <div class="col">
                <h5><i class="fas fa-credit-card me-2"></i>Payment Management Dashboard</h5>
                <p class="text-muted">Manage payment approvals, view statistics, and monitor transactions</p>
            </div>
        </div>
        
        <!-- Payment Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                        <h4 class="mb-0" id="pendingPayments">0</h4>
                        <small class="text-muted">Pending Approvals</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <i class="fas fa-dollar-sign fa-2x text-success mb-2"></i>
                        <h4 class="mb-0" id="totalRevenue">$0.00</h4>
                        <small class="text-muted">Total Revenue (30d)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h4 class="mb-0" id="approvedPayments">0</h4>
                        <small class="text-muted">Approved (30d)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                        <h4 class="mb-0" id="rejectedPayments">0</h4>
                        <small class="text-muted">Rejected (30d)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Management Tabs -->
        <ul class="nav nav-tabs mb-3" id="paymentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                    <i class="fas fa-clock me-1"></i>
                    Pending Approvals
                    <span class="badge bg-warning ms-1" id="pendingBadge">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab">
                    <i class="fas fa-check me-1"></i>
                    Approved Payments
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab">
                    <i class="fas fa-times me-1"></i>
                    Rejected Payments
                </button>
            </li>
        </ul>

        <!-- Payment Tab Content -->
        <div class="tab-content" id="paymentTabContent">
            <!-- Pending Payments Tab -->
            <div class="tab-pane fade show active" id="pending" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-clock me-2"></i>
                            Pending Payment Approvals
                        </h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshPendingPayments()">
                            <i class="fas fa-sync-alt me-1"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="pendingPaymentsContent">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p>Loading pending payments...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Approved Payments Tab -->
            <div class="tab-pane fade" id="approved" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-check me-2"></i>
                            Approved Payments (Last 30 Days)
                        </h6>
                        <button class="btn btn-sm btn-outline-success" onclick="refreshApprovedPayments()">
                            <i class="fas fa-sync-alt me-1"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="approvedPaymentsContent">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p>Loading approved payments...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rejected Payments Tab -->
            <div class="tab-pane fade" id="rejected" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-times me-2"></i>
                            Rejected Payments (Last 30 Days)
                        </h6>
                        <button class="btn btn-sm btn-outline-danger" onclick="refreshRejectedPayments()">
                            <i class="fas fa-sync-alt me-1"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="rejectedPaymentsContent">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p>Loading rejected payments...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="settings" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-cog me-2"></i>
                            System Settings
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="settingsForm">
                            <h6 class="mb-3">Credit Costs</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Math Easy</label>
                                    <input type="number" class="form-control" id="mathEasy" value="5">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Math Medium</label>
                                    <input type="number" class="form-control" id="mathMedium" value="10">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Math Difficult</label>
                                    <input type="number" class="form-control" id="mathDifficult" value="20">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Science Easy</label>
                                    <input type="number" class="form-control" id="scienceEasy" value="5">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Science Medium</label>
                                    <input type="number" class="form-control" id="scienceMedium" value="10">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Science Difficult</label>
                                    <input type="number" class="form-control" id="scienceDifficult" value="15">
                                </div>
                            </div>

                            <hr>
                            
                            <h6 class="mb-3">Rate Limiting</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Session Cooldown (seconds)</label>
                                    <input type="number" class="form-control" id="sessionCooldown" value="30">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Generation Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="generationTimeout" value="120">
                                </div>
                            </div>

                            <hr>
                            
                            <h6 class="mb-3">Bonuses</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Welcome Credits</label>
                                    <input type="number" class="form-control" id="welcomeCredits" value="50">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Referrer Bonus</label>
                                    <input type="number" class="form-control" id="referrerBonus" value="25">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">New User Referral Bonus</label>
                                    <input type="number" class="form-control" id="newUserBonus" value="15">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>
                                Save Settings
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-broadcast-tower me-2"></i>
                            Broadcast Message
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="broadcastForm">
                            <div class="mb-3">
                                <label for="broadcastTarget" class="form-label">Target</label>
                                <select class="form-select" id="broadcastTarget">
                                    <option value="all">All Users</option>
                                    <option value="active">Active Users (Last 7 days)</option>
                                    <option value="inactive">Inactive Users (7+ days)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="broadcastMessage" class="form-label">Message</label>
                                <textarea class="form-control" id="broadcastMessage" rows="4" maxlength="1000" placeholder="Enter broadcast message..."></textarea>
                                <div class="form-text">Max 1000 characters</div>
                            </div>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-bullhorn me-1"></i>
                                Send Broadcast
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Broadcast History -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>
                            Recent Broadcasts
                        </h6>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="broadcastHistory">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <small class="d-block mt-2">Loading...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Topics data for dynamic loading
const TOPICS = {
    "Mathematics": ["Real Numbers", "Sets", "Financial Mathematics", "Measures and Mensuration", "Graphs", "Variation", "Algebra", "Geometry", "Statistics", "Trigonometry", "Vectors", "Matrices", "Transformation", "Probability"],
    "Biology": ["Laboratory rules and safety", "Cells and levels of organization", "Nutrition", "Respiratory system", "Transport systems", "Reproduction in plants and animals", "Health and diseases"],
    "Chemistry": ["Matter", "Acids, Bases and Salts", "Oxidation and Reduction", "Industrial Processes", "Organic Chemistry"],
    "Physics": ["Measurements", "Force", "Energy", "Magnetism", "Electricity"],
    "English": ["Formal Letter Writing", "Informal Letter Writing", "Article Writing", "Report Writing", "Speech Writing", "Narrative Essays", "Descriptive Essays", "Argumentative Essays", "Comprehension Skills", "Vocabulary Building", "Grammar and Language", "Literary Devices", "Reading Skills", "Writing Skills"]
};

// Initialize admin panel
document.addEventListener('DOMContentLoaded', function() {
    console.log('Admin panel DOM loaded, initializing...');
    
    // Check if required elements exist
    const requiredElements = [
        'pendingPaymentsContent',
        'approvedPaymentsContent', 
        'rejectedPaymentsContent',
        'pendingPayments',
        'totalRevenue',
        'approvedPayments',
        'rejectedPayments'
    ];
    
    const missingElements = requiredElements.filter(id => !document.getElementById(id));
    if (missingElements.length > 0) {
        console.error('Missing required elements:', missingElements);
    } else {
        console.log('All required elements found');
    }
    
    loadPaymentStats();
    loadSystemSettings();
    loadCreditStatistics();
    loadBroadcastHistory();
    
    // Setup subject change handler
    document.getElementById('questionSubject').addEventListener('change', updateTopics);
    
    // Setup bulk target change handler
    document.getElementById('bulkTarget').addEventListener('change', handleBulkTargetChange);
    
    // Setup form handlers
    document.getElementById('creditForm').addEventListener('submit', handleCreditForm);
    document.getElementById('resetCreditForm').addEventListener('submit', handleResetCreditForm);
    document.getElementById('bulkCreditForm').addEventListener('submit', handleBulkCreditForm);
    document.getElementById('questionForm').addEventListener('submit', handleQuestionForm);
    document.getElementById('settingsForm').addEventListener('submit', handleSettingsForm);
    document.getElementById('broadcastForm').addEventListener('submit', handleBroadcastForm);
    
    // Auto-refresh credit statistics every 30 seconds
    setInterval(loadCreditStatistics, 30000);
    
    // Auto-refresh broadcast history every 60 seconds
    setInterval(loadBroadcastHistory, 60000);
});

function updateTopics() {
    const subjectSelect = document.getElementById('questionSubject');
    const topicSelect = document.getElementById('questionTopic');
    const subject = subjectSelect.value;
    
    topicSelect.innerHTML = '<option value="">Select topic</option>';
    
    if (subject && TOPICS[subject]) {
        TOPICS[subject].forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            option.textContent = topic;
            topicSelect.appendChild(option);
        });
    }
}

function searchUsers() {
    const query = document.getElementById('userSearch').value.trim();
    const searchType = document.getElementById('searchType').value;
    
    if (!query) {
        alert('Please enter a search query');
        return;
    }
    
    const tableBody = document.getElementById('usersTable');
    tableBody.innerHTML = '<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Searching...</td></tr>';
    
    fetch(`/api/admin/api/users/search?q=${encodeURIComponent(query)}&type=${searchType}`)
        .then(response => response.json())
        .then(data => {
            if (data.users && data.users.length > 0) {
                displayUsers(data.users);
            } else {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No users found</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error searching users:', error);
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error searching users</td></tr>';
        });
}

function displayUsers(users) {
    const tableBody = document.getElementById('usersTable');
    
    tableBody.innerHTML = users.map(user => `
        <tr>
            <td>${user.nerdx_id || 'N/A'}</td>
            <td>${user.name || 'N/A'} ${user.surname || ''}</td>
            <td>${user.credits || 0}</td>
            <td>${user.total_points || 0}</td>
            <td>${user.streak_count || 0}</td>
            <td>
                <span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">
                    ${user.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary me-1" onclick="viewUserDetails('${user.whatsapp_id}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-warning me-1" onclick="editCredits('${user.whatsapp_id}')">
                    <i class="fas fa-coins"></i>
                </button>
                <button class="btn btn-sm btn-secondary" onclick="toggleUserStatus('${user.whatsapp_id}', ${!user.is_active})">
                    <i class="fas fa-${user.is_active ? 'ban' : 'check'}"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function handleCreditForm(e) {
    e.preventDefault();
    
    const userId = document.getElementById('creditUserId').value;
    const action = document.getElementById('creditAction').value;
    const amount = parseInt(document.getElementById('creditAmount').value);
    const reason = document.getElementById('creditReason').value;
    
    if (!userId || !action || !amount || !reason) {
        alert('Please fill all fields');
        return;
    }
    
    fetch(`/api/admin/api/users/${userId}/credits`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: action,
            amount: amount,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById('creditForm').reset();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error managing credits:', error);
        alert('Error processing credit operation');
    });
}

function handleQuestionForm(e) {
    e.preventDefault();
    
    const subject = document.getElementById('questionSubject').value;
    const topic = document.getElementById('questionTopic').value;
    const difficulty = document.getElementById('questionDifficulty').value;
    const count = parseInt(document.getElementById('questionCount').value);
    
    if (!subject || !topic || !difficulty || !count) {
        alert('Please fill all fields');
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
    
    fetch('/api/admin/api/questions/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            subject: subject,
            topic: topic,
            difficulty: difficulty,
            count: count
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayGeneratedQuestions(data.questions);
            alert(`Successfully generated ${data.generated} out of ${data.requested} questions`);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error generating questions:', error);
        alert('Error generating questions');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-magic me-1"></i>Generate Questions';
    });
}

function displayGeneratedQuestions(questions) {
    const container = document.getElementById('generatedQuestions');
    
    if (!questions || questions.length === 0) {
        container.innerHTML = '<p class="text-muted">No questions generated</p>';
        return;
    }
    
    container.innerHTML = questions.map(q => `
        <div class="card mb-2">
            <div class="card-body">
                <h6 class="card-title">${q.subject} - ${q.topic}</h6>
                <p class="card-text">${q.question}</p>
                <small class="text-muted">Difficulty: ${q.difficulty} | Points: ${q.points}</small>
            </div>
        </div>
    `).join('');
}

function loadPaymentStats() {
    fetch('/api/admin/api/payments/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalRevenue').textContent = `$${data.total_revenue || 0}`;
            document.getElementById('totalTransactions').textContent = data.total_transactions || 0;
            document.getElementById('successfulPayments').textContent = data.successful_payments || 0;
            document.getElementById('failedPayments').textContent = data.failed_transactions || 0;
        })
        .catch(error => {
            console.error('Error loading payment stats:', error);
        });
}

function loadSystemSettings() {
    fetch('/api/admin/api/system/settings')
        .then(response => response.json())
        .then(data => {
            // Load credit costs
            document.getElementById('mathEasy').value = data.credit_costs?.math_easy || 5;
            document.getElementById('mathMedium').value = data.credit_costs?.math_medium || 10;
            document.getElementById('mathDifficult').value = data.credit_costs?.math_difficult || 20;
            document.getElementById('scienceEasy').value = data.credit_costs?.science_easy || 5;
            document.getElementById('scienceMedium').value = data.credit_costs?.science_medium || 10;
            document.getElementById('scienceDifficult').value = data.credit_costs?.science_difficult || 15;
            
            // Load rate limits
            document.getElementById('sessionCooldown').value = data.rate_limits?.session_cooldown || 30;
            document.getElementById('generationTimeout').value = data.rate_limits?.generation_timeout || 120;
            
            // Load bonuses
            document.getElementById('welcomeCredits').value = data.welcome_credits || 50;
            document.getElementById('referrerBonus').value = data.referral_credits?.referrer_bonus || 25;
            document.getElementById('newUserBonus').value = data.referral_credits?.new_user_bonus || 15;
        })
        .catch(error => {
            console.error('Error loading system settings:', error);
        });
}

function handleSettingsForm(e) {
    e.preventDefault();
    
    const settings = {
        credit_costs: {
            math_easy: parseInt(document.getElementById('mathEasy').value),
            math_medium: parseInt(document.getElementById('mathMedium').value),
            math_difficult: parseInt(document.getElementById('mathDifficult').value),
            science_easy: parseInt(document.getElementById('scienceEasy').value),
            science_medium: parseInt(document.getElementById('scienceMedium').value),
            science_difficult: parseInt(document.getElementById('scienceDifficult').value)
        },
        rate_limits: {
            session_cooldown: parseInt(document.getElementById('sessionCooldown').value),
            generation_timeout: parseInt(document.getElementById('generationTimeout').value)
        },
        welcome_credits: parseInt(document.getElementById('welcomeCredits').value),
        referral_credits: {
            referrer_bonus: parseInt(document.getElementById('referrerBonus').value),
            new_user_bonus: parseInt(document.getElementById('newUserBonus').value)
        }
    };
    
    fetch('/api/admin/api/system/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Settings saved successfully');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving settings:', error);
        alert('Error saving settings');
    });
}

function handleBroadcastForm(e) {
    e.preventDefault();
    
    const target = document.getElementById('broadcastTarget').value;
    const message = document.getElementById('broadcastMessage').value.trim();
    
    if (!message) {
        alert('Please enter a message');
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    if (confirm(`Send broadcast to ${target} users?`)) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
        
        fetch('/api/admin/api/broadcast', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                target: target,
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${data.message}\n\nSent to: ${data.successful_sends} users\nFailed: ${data.failed_sends} users`);
                document.getElementById('broadcastForm').reset();
                loadBroadcastHistory(); // Refresh history
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error sending broadcast:', error);
            alert('Error sending broadcast');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    }
}

function loadBroadcastHistory() {
    fetch('/api/admin/api/broadcast/history')
        .then(response => response.json())
        .then(data => {
            displayBroadcastHistory(data.broadcasts || []);
        })
        .catch(error => {
            console.error('Error loading broadcast history:', error);
            document.getElementById('broadcastHistory').innerHTML = '<p class="text-danger text-center">Error loading broadcast history</p>';
        });
}

function displayBroadcastHistory(broadcasts) {
    const container = document.getElementById('broadcastHistory');
    
    if (broadcasts.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No broadcasts sent yet</p>';
        return;
    }
    
    container.innerHTML = broadcasts.map(broadcast => {
        const date = new Date(broadcast.created_at).toLocaleString();
        const successRate = broadcast.success_rate;
        const statusColor = successRate >= 90 ? 'text-success' : successRate >= 70 ? 'text-warning' : 'text-danger';
        
        return `
            <div class="border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="fw-bold">${broadcast.target_group.toUpperCase()}</div>
                        <div class="text-muted small">${broadcast.message}</div>
                        <div class="small text-secondary">${date}</div>
                    </div>
                    <div class="text-end ms-2">
                        <div class="${statusColor} fw-bold">${successRate}%</div>
                        <div class="small text-muted">
                            ${broadcast.successful_sends}/${broadcast.total_recipients}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function viewUserDetails(userId) {
    const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
    modal.show();
    
    fetch(`/api/dashboard/api/user/${userId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('userDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <p><strong>Credits:</strong> ${data.credits || 0}</p>
                        <p><strong>Total Points:</strong> ${data.total_points || 0}</p>
                        <p><strong>Current Streak:</strong> ${data.streak_count || 0} days</p>
                        <p><strong>Level:</strong> ${data.level?.name || 'Unknown'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Activity</h6>
                        <p><strong>Questions Answered:</strong> ${data.questions_answered || 0}</p>
                        <p><strong>Accuracy:</strong> ${data.accuracy || 0}%</p>
                        <p><strong>Last Activity:</strong> ${data.last_activity || 'Never'}</p>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            document.getElementById('userDetailsContent').innerHTML = '<p class="text-danger">Error loading user details</p>';
        });
}

function editCredits(userId) {
    document.getElementById('creditUserId').value = userId;
    document.querySelector('[href="#credits"]').click();
}

function exportUsers() {
    fetch('/api/dashboard/api/export/users')
        .then(response => response.json())
        .then(data => {
            alert(data.message || 'Export started');
        })
        .catch(error => {
            console.error('Error exporting users:', error);
            alert('Error starting export');
        });
}

// ================================
// CREDIT MANAGEMENT FUNCTIONS
// ================================

function loadCreditStatistics() {
    fetch('/api/admin/api/credits/statistics')
        .then(response => response.json())
        .then(data => {
            if (data.overview) {
                // Update statistics cards
                document.getElementById('totalUsers').textContent = data.overview.total_users.toLocaleString();
                document.getElementById('totalCredits').textContent = data.overview.total_credits.toLocaleString();
                document.getElementById('avgCredits').textContent = data.overview.avg_credits.toLocaleString();
                document.getElementById('lowCreditUsers').textContent = data.overview.low_credit_users.toLocaleString();
                
                // Update top users list
                displayTopUsers(data.top_users || []);
                
                // Update recent transactions
                displayRecentTransactions(data.recent_transactions || []);
            }
        })
        .catch(error => {
            console.error('Error loading credit statistics:', error);
        });
}

function displayTopUsers(users) {
    const container = document.getElementById('topUsersList');
    
    if (users.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No users found</p>';
        return;
    }
    
    container.innerHTML = users.map((user, index) => `
        <div class="d-flex justify-content-between align-items-center mb-2 p-2 ${index < 3 ? 'bg-light rounded' : ''}">
            <div>
                <div class="fw-bold">
                    ${index < 3 ? ['', '', ''][index] : `${index + 1}.`}
                    ${user.username}
                </div>
                <small class="text-muted">${user.user_id.slice(-8)}</small>
            </div>
            <div class="text-end">
                <div class="fw-bold text-success">${user.credits.toLocaleString()}</div>
                <small class="text-muted">credits</small>
            </div>
        </div>
    `).join('');
}

function displayRecentTransactions(transactions) {
    const container = document.getElementById('recentTransactions');
    
    if (transactions.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No recent transactions</p>';
        return;
    }
    
    container.innerHTML = transactions.map(tx => {
        const date = new Date(tx.date).toLocaleString();
        const typeColor = tx.credits_used > 0 ? 'text-danger' : 'text-success';
        const typeIcon = tx.credits_used > 0 ? 'fa-minus' : 'fa-plus';
        
        return `
            <div class="border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="fw-bold">${tx.user_id.slice(-8)}</div>
                        <small class="text-muted">${tx.type}</small>
                    </div>
                    <div class="text-end">
                        <div class="${typeColor}">
                            <i class="fas ${typeIcon}"></i> ${Math.abs(tx.credits_used)}
                        </div>
                        <small class="text-muted">${date}</small>
                    </div>
                </div>
                <small class="text-muted d-block">${tx.description}</small>
            </div>
        `;
    }).join('');
}

function handleBulkTargetChange() {
    const target = document.getElementById('bulkTarget').value;
    const specificDiv = document.getElementById('specificUsersDiv');
    
    if (target === 'specific_users') {
        specificDiv.style.display = 'block';
    } else {
        specificDiv.style.display = 'none';
    }
}

function handleResetCreditForm(e) {
    e.preventDefault();
    
    const userId = document.getElementById('resetUserId').value.trim();
    const amount = parseInt(document.getElementById('resetAmount').value);
    const reason = document.getElementById('resetReason').value.trim();
    
    if (!userId || !amount || !reason) {
        alert('Please fill all fields');
        return;
    }
    
    if (!confirm(`Reset user ${userId} credits to ${amount}? This action cannot be undone.`)) {
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Resetting...';
    
    fetch('/api/admin/api/credits/reset-user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user_id: userId,
            amount: amount,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById('resetCreditForm').reset();
            loadCreditStatistics(); // Refresh stats
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error resetting credits:', error);
        alert('Error resetting user credits');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function handleBulkCreditForm(e) {
    e.preventDefault();
    
    const target = document.getElementById('bulkTarget').value;
    const amount = parseInt(document.getElementById('bulkAmount').value);
    const reason = document.getElementById('bulkReason').value.trim();
    let userIds = [];
    
    if (target === 'specific_users') {
        const userIdsText = document.getElementById('specificUserIds').value.trim();
        if (!userIdsText) {
            alert('Please enter user IDs for specific users option');
            return;
        }
        userIds = userIdsText.split(',').map(id => id.trim()).filter(id => id);
        if (userIds.length === 0) {
            alert('Please enter valid user IDs');
            return;
        }
    }
    
    if (!target || !amount || !reason) {
        alert('Please fill all required fields');
        return;
    }
    
    const targetText = target === 'all' ? 'all users' : 
                     target === 'low_credits' ? 'users with low credits' : 
                     `${userIds.length} specific users`;
    
    if (!confirm(`Add ${amount} credits to ${targetText}? This will send ${amount} credits to each user.`)) {
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
    
    fetch('/api/admin/api/credits/bulk-refresh', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            target: target,
            amount: amount,
            reason: reason,
            user_ids: userIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showBulkResults(data);
            document.getElementById('bulkCreditForm').reset();
            handleBulkTargetChange(); // Reset visibility
            loadCreditStatistics(); // Refresh stats
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error bulk refreshing credits:', error);
        alert('Error processing bulk credit operation');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function quickBulkCredits(amount, target) {
    const targetText = target === 'all' ? 'all users' : 'users with low credits';
    
    if (!confirm(`Give ${amount} credits to ${targetText}?`)) {
        return;
    }
    
    fetch('/api/admin/api/credits/bulk-refresh', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            target: target,
            amount: amount,
            reason: `Quick admin credit boost - ${amount} credits`,
            user_ids: []
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showBulkResults(data);
            loadCreditStatistics(); // Refresh stats
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error in quick bulk credits:', error);
        alert('Error processing quick credit operation');
    });
}

function showBulkResults(data) {
    const modal = new bootstrap.Modal(document.getElementById('bulkResultModal'));
    const content = document.getElementById('bulkResultContent');
    
    content.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Bulk Operation Completed</h6>
            <p class="mb-0">${data.message}</p>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h4 text-success">${data.successful_updates}</div>
                    <small class="text-muted">Successful</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h4 text-danger">${data.failed_updates}</div>
                    <small class="text-muted">Failed</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h4 text-primary">${data.total_users}</div>
                    <small class="text-muted">Total Users</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h4 text-warning">${data.credits_added}</div>
                    <small class="text-muted">Credits Added</small>
                </div>
            </div>
        </div>
        
        ${data.updated_users && data.updated_users.length > 0 ? `
            <h6>Sample Updated Users:</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Before</th>
                            <th>After</th>
                            <th>Added</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.updated_users.map(user => `
                            <tr>
                                <td>${user.username} <small class="text-muted">(${user.user_id.slice(-8)})</small></td>
                                <td>${user.credits_before.toLocaleString()}</td>
                                <td class="text-success fw-bold">${user.credits_after.toLocaleString()}</td>
                                <td class="text-primary">+${user.credits_added}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            ${data.updated_users.length < data.successful_updates ? `
                <small class="text-muted">Showing first ${data.updated_users.length} of ${data.successful_updates} updated users</small>
            ` : ''}
        ` : ''}
    `;
    
    modal.show();
}

// ========================================
// PAYMENT MANAGEMENT FUNCTIONS
// ========================================

// Load payment statistics
function loadPaymentStats() {
    fetch('/admin/payments/api/stats')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const pendingElement = document.getElementById('pendingPayments');
            const revenueElement = document.getElementById('totalRevenue');
            const approvedElement = document.getElementById('approvedPayments');
            const rejectedElement = document.getElementById('rejectedPayments');
            
            if (pendingElement) pendingElement.textContent = data.pending_count || 0;
            if (revenueElement) revenueElement.textContent = data.total_revenue || '$0.00';
            if (approvedElement) approvedElement.textContent = data.approved_count || 0;
            if (rejectedElement) rejectedElement.textContent = data.rejected_count || 0;
            
            // Update pending badge
            const pendingBadge = document.getElementById('pendingBadge');
            if (pendingBadge) {
                pendingBadge.textContent = data.pending_count || 0;
                if (data.pending_count > 0) {
                    pendingBadge.className = 'badge bg-warning ms-1';
                } else {
                    pendingBadge.className = 'badge bg-secondary ms-1';
                }
            }
        })
        .catch(error => {
            console.error('Error loading payment stats:', error);
        });
}

// Load pending payments
function loadPendingPayments() {
    const container = document.getElementById('pendingPaymentsContent');
    if (!container) {
        console.error('Element with id "pendingPaymentsContent" not found');
        return;
    }
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Loading pending payments...</p>
        </div>
    `;
    
    fetch('/admin/payments/api/pending')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            displayPendingPayments(data);
        })
        .catch(error => {
            console.error('Error loading pending payments:', error);
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading pending payments: ${error.message}
                        <br><small>Please check the console for more details.</small>
                    </div>
                `;
            }
        });
}

// Display pending payments
function displayPendingPayments(payments) {
    const container = document.getElementById('pendingPaymentsContent');
    
    if (!container) {
        console.error('Element with id "pendingPaymentsContent" not found');
        return;
    }
    
    if (!payments || payments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                <p>No pending payments to approve</p>
                <small>All payments have been processed</small>
            </div>
        `;
        return;
    }
    
    container.innerHTML = payments.map(payment => `
        <div class="card mb-3 border-warning">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="card-title mb-1">
                                    <i class="fas fa-user me-2"></i>
                                    ${payment.user_name} ${payment.user_surname}
                                </h6>
                                <small class="text-muted">
                                    <i class="fas fa-phone me-1"></i>
                                    ${payment.user_id}
                                </small>
                            </div>
                            <span class="badge bg-warning">Pending Approval</span>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-md-4">
                                <strong>Package:</strong> ${payment.package_name}
                            </div>
                            <div class="col-md-4">
                                <strong>Amount:</strong> ${payment.formatted_amount}
                            </div>
                            <div class="col-md-4">
                                <strong>Credits:</strong> ${payment.credits}
                            </div>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <strong>Reference:</strong> <code>${payment.reference_code}</code>
                            </div>
                            <div class="col-md-6">
                                <strong>Submitted:</strong> ${payment.time_ago}
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <strong>Payment Proof:</strong>
                            <div class="bg-light p-2 rounded mt-1">
                                <small>${payment.payment_proof}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-sm" onclick="approvePayment('${payment.reference_code}')">
                                <i class="fas fa-check me-1"></i>
                                Approve Payment
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectPayment('${payment.reference_code}')">
                                <i class="fas fa-times me-1"></i>
                                Reject Payment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Approve payment
function approvePayment(referenceCode) {
    const adminNotes = prompt('Enter admin notes (optional):');
    
    if (adminNotes === null) return; // User cancelled
    
    const approveBtn = event.target;
    const originalText = approveBtn.innerHTML;
    approveBtn.disabled = true;
    approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Approving...';
    
    fetch(`/api/admin/payments/approve/${referenceCode}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `admin_notes=${encodeURIComponent(adminNotes)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', `Payment ${referenceCode} approved successfully! ${data.credits} credits added to user account.`);
            loadPaymentStats(); // Refresh stats
            loadPendingPayments(); // Refresh pending payments
        } else {
            showAlert('danger', `Failed to approve payment: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error approving payment:', error);
        showAlert('danger', 'Error approving payment. Please try again.');
    })
    .finally(() => {
        approveBtn.disabled = false;
        approveBtn.innerHTML = originalText;
    });
}

// Reject payment
function rejectPayment(referenceCode) {
    const adminNotes = prompt('Enter rejection reason (required):');
    
    if (!adminNotes || adminNotes.trim() === '') {
        alert('Please provide a rejection reason');
        return;
    }
    
    const rejectBtn = event.target;
    const originalText = rejectBtn.innerHTML;
    rejectBtn.disabled = true;
    rejectBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Rejecting...';
    
    fetch(`/api/admin/payments/reject/${referenceCode}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `admin_notes=${encodeURIComponent(adminNotes)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', `Payment ${referenceCode} rejected successfully. User will be notified.`);
            loadPaymentStats(); // Refresh stats
            loadPendingPayments(); // Refresh pending payments
        } else {
            showAlert('danger', `Failed to reject payment: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error rejecting payment:', error);
        showAlert('danger', 'Error rejecting payment. Please try again.');
    })
    .finally(() => {
        rejectBtn.disabled = false;
        rejectBtn.innerHTML = originalText;
    });
}

// Load approved payments
function loadApprovedPayments() {
    const container = document.getElementById('approvedPaymentsContent');
    if (!container) {
        console.error('Element with id "approvedPaymentsContent" not found');
        return;
    }
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Loading approved payments...</p>
        </div>
    `;
    
    fetch('/admin/payments/api/approved')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            displayApprovedPayments(data);
        })
        .catch(error => {
            console.error('Error loading approved payments:', error);
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading approved payments: ${error.message}
                        <br><small>Please check the console for more details.</small>
                    </div>
                `;
            }
        });
}

// Display approved payments
function displayApprovedPayments(payments) {
    const container = document.getElementById('approvedPaymentsContent');
    
    if (!container) {
        console.error('Element with id "approvedPaymentsContent" not found');
        return;
    }
    
    if (!payments || payments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-2 text-info"></i>
                <p>No approved payments in the last 30 days</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Package</th>
                        <th>Amount</th>
                        <th>Credits</th>
                        <th>Reference</th>
                        <th>Approved</th>
                    </tr>
                </thead>
                <tbody>
                    ${payments.map(payment => `
                        <tr>
                            <td>
                                <div>
                                    <strong>${payment.user_name} ${payment.user_surname}</strong>
                                    <br><small class="text-muted">${payment.user_id}</small>
                                </div>
                            </td>
                            <td>${payment.package_name}</td>
                            <td>${payment.formatted_amount}</td>
                            <td><span class="badge bg-success">${payment.credits}</span></td>
                            <td><code>${payment.reference_code}</code></td>
                            <td>
                                <small>${payment.time_ago}</small>
                                <br><small class="text-muted">${payment.formatted_approved_at}</small>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Load rejected payments
function loadRejectedPayments() {
    const container = document.getElementById('rejectedPaymentsContent');
    if (!container) {
        console.error('Element with id "rejectedPaymentsContent" not found');
        return;
    }
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Loading rejected payments...</p>
        </div>
    `;
    
    fetch('/admin/payments/api/rejected')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            displayRejectedPayments(data);
        })
        .catch(error => {
            console.error('Error loading rejected payments:', error);
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading rejected payments: ${error.message}
                        <br><small>Please check the console for more details.</small>
                    </div>
                `;
            }
        });
}

// Display rejected payments
function displayRejectedPayments(payments) {
    const container = document.getElementById('rejectedPaymentsContent');
    
    if (!container) {
        console.error('Element with id "rejectedPaymentsContent" not found');
        return;
    }
    
    if (!payments || payments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-2 text-info"></i>
                <p>No rejected payments in the last 30 days</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Package</th>
                        <th>Amount</th>
                        <th>Credits</th>
                        <th>Reference</th>
                        <th>Rejected</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody>
                    ${payments.map(payment => `
                        <tr>
                            <td>
                                <div>
                                    <strong>${payment.user_name} ${payment.user_surname}</strong>
                                    <br><small class="text-muted">${payment.user_id}</small>
                                </div>
                            </td>
                            <td>${payment.package_name}</td>
                            <td>${payment.formatted_amount}</td>
                            <td><span class="badge bg-secondary">${payment.credits}</span></td>
                            <td><code>${payment.reference_code}</code></td>
                            <td>
                                <small>${payment.time_ago}</small>
                                <br><small class="text-muted">${payment.formatted_rejected_at}</small>
                            </td>
                            <td>
                                <small class="text-muted">${payment.admin_notes || 'No reason provided'}</small>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Refresh functions
function refreshPendingPayments() {
    loadPendingPayments();
}

function refreshApprovedPayments() {
    loadApprovedPayments();
}

function refreshRejectedPayments() {
    loadRejectedPayments();
}

// Show alert function
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the payments tab
    const paymentsTab = document.getElementById('payments');
    paymentsTab.insertBefore(alertDiv, paymentsTab.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Initialize payment dashboard when tab is shown
document.addEventListener('DOMContentLoaded', function() {
    // Load payment stats when payments tab is clicked
    const paymentsTab = document.getElementById('payments-tab');
    paymentsTab.addEventListener('click', function() {
        loadPaymentStats();
        loadPendingPayments();
    });
    
    // Load approved payments when approved tab is clicked
    const approvedTab = document.getElementById('approved-tab');
    approvedTab.addEventListener('click', function() {
        loadApprovedPayments();
    });
    
    // Load rejected payments when rejected tab is clicked
    const rejectedTab = document.getElementById('rejected-tab');
    rejectedTab.addEventListener('click', function() {
        loadRejectedPayments();
    });
});
</script>
{% endblock %}
