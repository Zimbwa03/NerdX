{% extends "base.html" %}

{% block title %}School Detail - NerdX Dashboard{% endblock %}

{% block extra_head %}
<style>
/* ── AI Chat Panel ── Premium Chat UI ──────────────────────────────────── */
.ai-chat-panel {
    border: 1px solid rgba(124,77,255,0.35);
    border-radius: 16px;
    overflow: hidden;
    background: #0f0f23;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 24px rgba(124,77,255,0.08), 0 1px 4px rgba(0,0,0,0.2);
}
.ai-chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    background: linear-gradient(135deg, #1e1042 0%, #0f172a 100%);
    border-bottom: 1px solid rgba(124,77,255,0.18);
    cursor: pointer;
    user-select: none;
}
.ai-chat-header h6 {
    margin: 0;
    color: #c4b5fd;
    font-weight: 700;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 10px;
    letter-spacing: 0.01em;
}
.ai-chat-header h6 i.fas {
    font-size: 1.15rem;
    background: linear-gradient(135deg, #7c4dff, #00e5ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.ai-chat-header .badge {
    background: linear-gradient(135deg, #7c4dff, #651fff);
    font-size: 0.65rem;
    padding: 3px 8px;
    border-radius: 6px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
}
.ai-chat-header .ai-status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #10b981;
    display: inline-block;
    margin-left: 4px;
    box-shadow: 0 0 6px rgba(16,185,129,0.5);
    animation: aiPulse 2s infinite;
}
@keyframes aiPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
.ai-chat-toggle {
    background: rgba(124,77,255,0.12);
    border: 1px solid rgba(124,77,255,0.2);
    color: #a78bfa;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}
.ai-chat-toggle:hover {
    background: rgba(124,77,255,0.2);
    border-color: rgba(124,77,255,0.4);
}
.ai-chat-toggle.open {
    transform: rotate(180deg);
}

/* Chat body */
.ai-chat-body {
    display: none;
    flex-direction: column;
    height: 460px;
    background: linear-gradient(180deg, #0f0f23 0%, #13132b 100%);
}
.ai-chat-body.open {
    display: flex;
    animation: aiFadeIn 0.25s ease;
}
@keyframes aiFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Messages */
.ai-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 18px 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    scrollbar-width: thin;
    scrollbar-color: rgba(124,77,255,0.3) transparent;
}
.ai-chat-messages::-webkit-scrollbar {
    width: 5px;
}
.ai-chat-messages::-webkit-scrollbar-thumb {
    background: rgba(124,77,255,0.3);
    border-radius: 4px;
}
.ai-chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

/* Message bubbles */
.ai-msg {
    max-width: 82%;
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 0.875rem;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;
    position: relative;
    animation: aiMsgIn 0.2s ease;
}
@keyframes aiMsgIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.ai-msg--user {
    align-self: flex-end;
    background: linear-gradient(135deg, #7c4dff, #651fff);
    color: #f0ecff;
    border-bottom-right-radius: 4px;
    box-shadow: 0 2px 8px rgba(124,77,255,0.25);
}

.ai-msg--ai {
    align-self: flex-start;
    background: rgba(255,255,255,0.05);
    color: #d1d5db;
    border: 1px solid rgba(255,255,255,0.06);
    border-bottom-left-radius: 4px;
    backdrop-filter: blur(4px);
}
.ai-msg--ai strong, .ai-msg--ai b {
    color: #c4b5fd;
    font-weight: 600;
}

.ai-msg--system {
    align-self: center;
    background: rgba(16, 185, 129, 0.1);
    color: #6ee7b7;
    font-size: 0.8rem;
    border-radius: 10px;
    padding: 8px 16px;
    text-align: center;
    border: 1px solid rgba(16,185,129,0.15);
}

.ai-msg--error {
    align-self: center;
    background: rgba(239, 68, 68, 0.1);
    color: #fca5a5;
    font-size: 0.8rem;
    border-radius: 10px;
    padding: 8px 16px;
    border: 1px solid rgba(239,68,68,0.15);
}

.ai-msg__img-preview {
    max-width: 220px;
    max-height: 160px;
    border-radius: 10px;
    margin-bottom: 6px;
    border: 2px solid rgba(124,77,255,0.25);
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
}

/* Typing indicator */
.ai-typing {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 12px 16px;
    align-self: flex-start;
    background: rgba(255,255,255,0.05);
    border-radius: 16px;
    border-bottom-left-radius: 4px;
    border: 1px solid rgba(255,255,255,0.06);
}
.ai-typing span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: linear-gradient(135deg, #7c4dff, #00e5ff);
    animation: aiDot 1.4s infinite;
}
.ai-typing span:nth-child(2) { animation-delay: 0.2s; }
.ai-typing span:nth-child(3) { animation-delay: 0.4s; }
@keyframes aiDot {
    0%, 80%, 100% { opacity: 0.25; transform: scale(0.7); }
    40% { opacity: 1; transform: scale(1.1); }
}

/* Input bar */
.ai-chat-input-bar {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    padding: 14px 18px;
    background: rgba(0,0,0,0.35);
    border-top: 1px solid rgba(124,77,255,0.1);
}
.ai-chat-input-bar textarea {
    flex: 1;
    resize: none;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    color: #fff;
    padding: 10px 14px;
    font-size: 0.875rem;
    max-height: 90px;
    min-height: 42px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    font-family: inherit;
    line-height: 1.5;
}
.ai-chat-input-bar textarea:focus {
    border-color: rgba(124,77,255,0.5);
    box-shadow: 0 0 0 2px rgba(124,77,255,0.1);
}
.ai-chat-input-bar textarea::placeholder {
    color: rgba(255,255,255,0.3);
}

/* Buttons */
.ai-chat-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
}
.ai-chat-btn--upload {
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.6);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.08);
}
.ai-chat-btn--upload:hover {
    background: rgba(255,255,255,0.12);
    color: #fff;
    border-color: rgba(124,77,255,0.3);
}
.ai-chat-btn--upload input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
}
.ai-chat-btn--send {
    background: linear-gradient(135deg, #7c4dff, #651fff);
    color: #fff;
    box-shadow: 0 2px 8px rgba(124,77,255,0.3);
}
.ai-chat-btn--send:hover {
    background: linear-gradient(135deg, #6d3fe8, #5c2fd6);
    box-shadow: 0 2px 12px rgba(124,77,255,0.4);
    transform: translateY(-1px);
}
.ai-chat-btn--send:disabled {
    opacity: 0.35;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Image preview strip */
.ai-image-preview {
    display: none;
    padding: 10px 18px;
    background: rgba(124,77,255,0.06);
    align-items: center;
    gap: 10px;
    border-top: 1px solid rgba(124,77,255,0.1);
}
.ai-image-preview.active { display: flex; }
.ai-image-preview img {
    width: 52px;
    height: 52px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid rgba(124,77,255,0.3);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.ai-image-preview .ai-preview-name {
    flex: 1;
    font-size: 0.82rem;
    color: rgba(255,255,255,0.55);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.ai-image-preview .ai-preview-remove {
    background: rgba(239,68,68,0.1);
    border: 1px solid rgba(239,68,68,0.2);
    color: #ef4444;
    cursor: pointer;
    font-size: 1rem;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}
.ai-image-preview .ai-preview-remove:hover {
    background: rgba(239,68,68,0.2);
}

/* ── Welcome message ── */
.ai-welcome {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 24px 20px 16px;
    gap: 12px;
}
.ai-welcome-icon {
    width: 56px;
    height: 56px;
    border-radius: 16px;
    background: linear-gradient(135deg, rgba(124,77,255,0.15), rgba(0,229,255,0.08));
    border: 1px solid rgba(124,77,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}
.ai-welcome-icon i {
    background: linear-gradient(135deg, #7c4dff, #00e5ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.ai-welcome h5 {
    color: #e2e8f0;
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
}
.ai-welcome p {
    color: rgba(255,255,255,0.45);
    font-size: 0.82rem;
    margin: 0;
    max-width: 320px;
    line-height: 1.5;
}
.ai-quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 4px;
}
.ai-quick-btn {
    background: rgba(124,77,255,0.08);
    border: 1px solid rgba(124,77,255,0.18);
    color: #c4b5fd;
    font-size: 0.78rem;
    padding: 6px 14px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}
.ai-quick-btn:hover {
    background: rgba(124,77,255,0.16);
    border-color: rgba(124,77,255,0.35);
    color: #e0d4ff;
}
.ai-quick-btn i {
    margin-right: 4px;
    font-size: 0.72rem;
}

/* ── Light theme ── */
[data-theme="light"] .ai-chat-panel {
    background: #ffffff;
    border-color: rgba(124,77,255,0.2);
    box-shadow: 0 4px 24px rgba(124,77,255,0.06), 0 1px 3px rgba(0,0,0,0.08);
}
[data-theme="light"] .ai-chat-header {
    background: linear-gradient(135deg, rgba(124,77,255,0.06), rgba(0,229,255,0.02));
    border-bottom-color: rgba(124,77,255,0.1);
}
[data-theme="light"] .ai-chat-header h6 { color: #5b21b6; }
[data-theme="light"] .ai-chat-body {
    background: linear-gradient(180deg, #fafafe 0%, #f5f3ff 100%);
}
[data-theme="light"] .ai-msg--user {
    background: linear-gradient(135deg, #7c4dff, #651fff);
    color: #fff;
}
[data-theme="light"] .ai-msg--ai {
    background: #fff;
    color: #1e293b;
    border-color: rgba(0,0,0,0.08);
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
[data-theme="light"] .ai-msg--ai strong,
[data-theme="light"] .ai-msg--ai b { color: #6d28d9; }
[data-theme="light"] .ai-chat-input-bar {
    background: rgba(124,77,255,0.03);
    border-top-color: rgba(0,0,0,0.06);
}
[data-theme="light"] .ai-chat-input-bar textarea {
    background: #fff;
    border-color: rgba(0,0,0,0.1);
    color: #1e293b;
}
[data-theme="light"] .ai-chat-input-bar textarea::placeholder {
    color: rgba(0,0,0,0.35);
}
[data-theme="light"] .ai-welcome h5 { color: #1e293b; }
[data-theme="light"] .ai-welcome p { color: rgba(0,0,0,0.5); }
[data-theme="light"] .ai-welcome-icon {
    background: linear-gradient(135deg, rgba(124,77,255,0.08), rgba(0,229,255,0.04));
    border-color: rgba(124,77,255,0.12);
}
[data-theme="light"] .ai-quick-btn {
    background: rgba(124,77,255,0.05);
    border-color: rgba(124,77,255,0.15);
    color: #6d28d9;
}
[data-theme="light"] .ai-quick-btn:hover {
    background: rgba(124,77,255,0.1);
    color: #5b21b6;
}
[data-theme="light"] .ai-image-preview {
    background: rgba(124,77,255,0.03);
    border-top-color: rgba(0,0,0,0.06);
}
[data-theme="light"] .ai-chat-toggle {
    background: rgba(124,77,255,0.06);
    border-color: rgba(124,77,255,0.12);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('schools.schools_list') }}">Schools</a></li>
                    <li class="breadcrumb-item active" aria-current="page" id="breadcrumbName">School</li>
                </ol>
            </nav>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div id="schoolLogoWrap" style="position:relative;cursor:pointer;" title="Click to upload logo">
                        <img id="schoolLogo" src="" alt="" style="width:56px;height:56px;border-radius:12px;object-fit:cover;border:2px solid rgba(255,255,255,0.1);display:none;">
                        <div id="schoolLogoPlaceholder" style="width:56px;height:56px;border-radius:12px;background:rgba(34,197,94,0.12);display:grid;place-items:center;border:2px solid rgba(34,197,94,0.2);color:#22c55e;font-size:1.5rem;">
                            <i class="fas fa-school"></i>
                        </div>
                        <input type="file" id="logoFileInput" accept="image/*" style="display:none;">
                        <div style="position:absolute;bottom:-4px;right:-4px;width:22px;height:22px;border-radius:50%;background:#22c55e;display:grid;place-items:center;font-size:0.6rem;color:#fff;border:2px solid #0f172a;">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div>
                        <h1 class="h2 mb-0" id="schoolName">&mdash;</h1>
                        <p class="text-muted mb-0">School ID: <code id="schoolIdDisplay">&mdash;</code> &middot; <span class="text-info" id="schoolSlugDisplay"></span></p>
                    </div>
                </div>
                <a href="{{ url_for('schools.schools_list') }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-1"></i> Back to list</a>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" id="schoolTabs">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabOverview">Overview</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabStudents">Students</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabFinance"><i class="fas fa-dollar-sign me-1"></i> Finance</a></li>
    </ul>

    <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="tabOverview">
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow h-100">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase mb-2">Subscription</h6>
                    <p class="mb-1"><strong id="subType">&mdash;</strong></p>
                    <p class="mb-1 small">Status: <span id="subStatus">&mdash;</span></p>
                    <p class="mb-0 small">Expires: <span id="subExpiry">&mdash;</span></p>
                    <hr>
                    <div class="d-flex gap-2 flex-wrap">
                        <select class="form-select form-select-sm" id="subTypeSelect" style="max-width:140px;">
                            <option value="monthly">Monthly</option>
                            <option value="custom_months">Custom Months</option>
                            <option value="term">Term (3 mo)</option>
                        </select>
                        <input type="number" class="form-control form-control-sm" id="subMonths" min="1" max="12" value="1" style="width:70px;" placeholder="Mo">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btnUpdateSub">Update</button>
                        <button type="button" class="btn btn-sm btn-success" id="btnRenewSub">Renew</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow h-100">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase mb-2">Registered Students</h6>
                    <p class="h4 mb-0" id="studentCount">0</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow h-100 border-info">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase mb-2"><i class="fas fa-link me-1"></i> School Portal Link</h6>
                    <div id="dashboardLinkSection" style="display:none;">
                        <div style="background:rgba(6,182,212,0.08);border:1px solid rgba(6,182,212,0.25);border-radius:8px;padding:10px 14px;margin-bottom:10px;word-break:break-all;">
                            <code id="dashboardUrlDisplay" style="font-size:0.82rem;color:#22d3ee;"></code>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-sm btn-info" id="btnCopyLink"><i class="fas fa-copy me-1"></i> Copy Link</button>
                            <button class="btn btn-sm btn-outline-success" id="btnCopyMessage"><i class="fas fa-share me-1"></i> Copy with Message</button>
                        </div>
                        <div id="linkCopiedAlert" class="alert alert-success py-1 px-2 mt-2 d-none" style="font-size:0.78rem;"><i class="fas fa-check me-1"></i> Copied to clipboard!</div>
                    </div>
                    <div id="dashboardLinkPlaceholder">
                        <p class="text-muted small mb-0">Loading school link...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Students Tab -->
    <div class="tab-pane fade" id="tabStudents">

    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Students</h5>
                    <div class="d-flex gap-2 align-items-center">
                        <button type="button" class="btn btn-outline-info btn-sm" id="btnToggleAiAssistant">
                            <i class="fas fa-robot me-1"></i> AI Assistant
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                            <i class="fas fa-plus me-1"></i> Add Student
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="ai-chat-panel" id="aiChatPanel">
                        <div class="ai-chat-header" id="aiChatHeaderToggle">
                            <h6>
                                <i class="fas fa-robot"></i>
                                AI Student Assistant
                                <span class="ai-status-dot"></span>
                                <span class="badge">Vertex AI</span>
                            </h6>
                            <button class="ai-chat-toggle" id="aiChatToggleBtn">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="ai-chat-body" id="aiChatBody">
                            <div class="ai-chat-messages" id="aiChatMessages">
                                <div class="ai-welcome" id="aiWelcomeBlock">
                                    <div class="ai-welcome-icon">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <h5>AI Student Manager</h5>
                                    <p>Upload an image of a student list or type a command. I can add, remove, and edit students for you.</p>
                                    <div class="ai-quick-actions">
                                        <button class="ai-quick-btn" data-msg="Show all students in this school">
                                            <i class="fas fa-list"></i> List students
                                        </button>
                                        <button class="ai-quick-btn" data-action="upload">
                                            <i class="fas fa-image"></i> Upload list
                                        </button>
                                        <button class="ai-quick-btn" data-msg="Add student John Doe Form 4">
                                            <i class="fas fa-user-plus"></i> Add student
                                        </button>
                                        <button class="ai-quick-btn" data-msg="Help me understand what you can do">
                                            <i class="fas fa-question-circle"></i> Help
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="ai-image-preview" id="aiImagePreview">
                                <img id="aiPreviewImg" src="" alt="preview">
                                <span class="ai-preview-name" id="aiPreviewName"></span>
                                <button class="ai-preview-remove" id="aiPreviewRemove" title="Remove image">&times;</button>
                            </div>
                            <div class="ai-chat-input-bar">
                                <button class="ai-chat-btn ai-chat-btn--upload" title="Upload student list image">
                                    <i class="fas fa-camera"></i>
                                    <input type="file" id="aiImageInput" accept="image/*">
                                </button>
                                <textarea id="aiChatInput" rows="1" placeholder="Ask me to add, remove, or edit students..."></textarea>
                                <button class="ai-chat-btn ai-chat-btn--send" id="aiChatSend" title="Send message">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="addStudentError" class="alert alert-danger d-none mb-3"></div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="studentsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Level</th>
                                    <th>Expiry</th>
                                </tr>
                            </thead>
                            <tbody id="studentsBody">
                                <tr><td colspan="3" class="text-center text-muted">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Finance Tab -->
    <div class="tab-pane fade" id="tabFinance">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card shadow border-success">
                    <div class="card-body text-center">
                        <h6 class="text-muted text-uppercase mb-1" style="font-size:0.7rem;">School Earnings (30%)</h6>
                        <p class="h3 text-success mb-0" id="finSchoolEarnings">$0.00</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow">
                    <div class="card-body text-center">
                        <h6 class="text-muted text-uppercase mb-1" style="font-size:0.7rem;">NerdX Share (70%)</h6>
                        <p class="h3 mb-0" id="finNerdxShare">$0.00</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow">
                    <div class="card-body text-center">
                        <h6 class="text-muted text-uppercase mb-1" style="font-size:0.7rem;">Total Paid</h6>
                        <p class="h3 text-info mb-0" id="finTotalPaid">$0.00</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow">
                    <div class="card-body text-center">
                        <h6 class="text-muted text-uppercase mb-1" style="font-size:0.7rem;">Amount Due</h6>
                        <p class="h3 text-warning mb-0" id="finAmountDue">$0.00</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">Payment History</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="paymentsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Students</th>
                                <th>Status</th>
                                <th>Receipt</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsBody">
                            <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    </div><!-- end tab-content -->
</div>

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="addStudentFormError" class="alert alert-danger d-none"></div>
                <form id="addStudentForm">
                    <div class="mb-3">
                        <label class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" required placeholder="e.g. John Doe">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Level / Form</label>
                        <input type="text" class="form-control" name="level" placeholder="e.g. Form 1, Form 4, A-Level">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSaveStudent">Save Student</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const detailUrl = '{{ url_for("schools.api_school_detail", school_pk=school_id) }}';
    const studentsUrl = '{{ url_for("schools.api_school_students_list", school_pk=school_id) }}';
    const updateUrl = '{{ url_for("schools.api_school_update", school_pk=school_id) }}';
    const aiChatUrl = '{{ url_for("schools.api_school_ai_chat", school_pk=school_id) }}';
    const financeUrl = '/admin/schools/{{ school_id }}/api/finance';
    const paymentsUrl = '/admin/schools/{{ school_id }}/api/payments';
    const logoUrl = '/admin/schools/{{ school_id }}/api/logo';

    // Logo upload
    document.getElementById('schoolLogoWrap').addEventListener('click', function() {
        document.getElementById('logoFileInput').click();
    });
    document.getElementById('logoFileInput').addEventListener('change', function() {
        const file = this.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            fetch(logoUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ logo_url: e.target.result }) })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('schoolLogo').src = data.logo_url;
                        document.getElementById('schoolLogo').style.display = 'block';
                        document.getElementById('schoolLogoPlaceholder').style.display = 'none';
                    }
                });
        };
        reader.readAsDataURL(file);
    });

    function loadSchool() {
        fetch(detailUrl, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('schoolName').textContent = 'Not found';
                    return;
                }
                document.getElementById('schoolName').textContent = data.name || '\u2014';
                document.getElementById('breadcrumbName').textContent = data.name || 'School';
                document.getElementById('schoolIdDisplay').textContent = data.school_id || '\u2014';
                document.getElementById('studentCount').textContent = data.student_count != null ? data.student_count : (data.students ? data.students.length : 0);

                // Logo
                if (data.logo_url) {
                    document.getElementById('schoolLogo').src = data.logo_url;
                    document.getElementById('schoolLogo').style.display = 'block';
                    document.getElementById('schoolLogoPlaceholder').style.display = 'none';
                }

                // Slug / Dashboard URL
                if (data.slug) {
                    document.getElementById('schoolSlugDisplay').textContent = '/' + data.slug;
                    const prodBase = 'https://nerdx.onrender.com';
                    const dashUrl = prodBase + '/school/' + data.slug;
                    document.getElementById('dashboardUrlDisplay').textContent = dashUrl;
                    document.getElementById('dashboardLinkSection').style.display = 'block';
                    document.getElementById('dashboardLinkPlaceholder').style.display = 'none';

                    document.getElementById('btnCopyLink').onclick = function() {
                        navigator.clipboard.writeText(dashUrl);
                        showCopiedAlert();
                    };
                    document.getElementById('btnCopyMessage').onclick = function() {
                        const msg = 'Hello ' + (data.name || 'School') + ',\n\n'
                            + 'Your NerdX School Dashboard is ready! Access it here:\n'
                            + dashUrl + '\n\n'
                            + 'Login with your School ID: ' + (data.school_id || '') + '\n\n'
                            + 'From this dashboard you can:\n'
                            + '• Monitor student activity & performance\n'
                            + '• View your earnings & financial reports\n'
                            + '• Make payments via EcoCash or Bank Transfer\n\n'
                            + 'NerdX Team';
                        navigator.clipboard.writeText(msg);
                        showCopiedAlert();
                    };
                }
                const subType = data.subscription_type || 'monthly';
                document.getElementById('subTypeSelect').value = subType;
                document.getElementById('subMonths').value = data.subscription_months || 1;
                document.getElementById('subType').textContent = subType === 'term' ? 'Term (90 days)' : (subType === 'custom_months' ? (data.subscription_months || 1) + ' months' : 'Monthly (30 days)');
                const isActive = !!data.is_active;
                document.getElementById('subStatus').innerHTML = isActive
                    ? '<span class="badge bg-success">Paid</span>'
                    : '<span class="badge bg-danger">Expired</span>';
                document.getElementById('subExpiry').textContent = data.subscription_expires_at ? new Date(data.subscription_expires_at).toLocaleDateString() : '\u2014';

                const students = data.students || [];
                const tbody = document.getElementById('studentsBody');
                if (students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No students yet. Click Add Student.</td></tr>';
                } else {
                    tbody.innerHTML = students.map(s => {
                        const fullName = (s.name || '') + ' ' + (s.surname || '');
                        const expiry = s.subscription_expires_at ? new Date(s.subscription_expires_at).toLocaleDateString() : '\u2014';
                        return '<tr><td>' + escapeHtml(fullName.trim()) + '</td><td>' + escapeHtml(s.student_level || '\u2014') + '</td><td>' + escapeHtml(expiry) + '</td></tr>';
                    }).join('');
                }
            })
            .catch(() => {
                document.getElementById('schoolName').textContent = 'Error loading';
                document.getElementById('studentsBody').innerHTML = '<tr><td colspan="3" class="text-center text-danger">Failed to load.</td></tr>';
            });
    }

    function showCopiedAlert() {
        const el = document.getElementById('linkCopiedAlert');
        el.classList.remove('d-none');
        setTimeout(function() { el.classList.add('d-none'); }, 2500);
    }

    function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    document.getElementById('btnUpdateSub').addEventListener('click', function() {
        const subType = document.getElementById('subTypeSelect').value;
        const months = parseInt(document.getElementById('subMonths').value, 10) || 1;
        fetch(updateUrl, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ subscription_type: subType, subscription_months: months }) })
            .then(r => r.json())
            .then(data => { if (data.success) loadSchool(); });
    });

    document.getElementById('btnRenewSub').addEventListener('click', function() {
        if (!confirm('Renew subscription from today?')) return;
        fetch(updateUrl, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ renew: true }) })
            .then(r => r.json())
            .then(data => { if (data.success) loadSchool(); });
    });

    document.getElementById('btnSaveStudent').addEventListener('click', function() {
        const form = document.getElementById('addStudentForm');
        const name = form.name.value.trim();
        if (!name) {
            document.getElementById('addStudentFormError').textContent = 'Full name is required.';
            document.getElementById('addStudentFormError').classList.remove('d-none');
            return;
        }
        document.getElementById('addStudentFormError').classList.add('d-none');
        this.disabled = true;
        fetch(studentsUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ name: name, level: form.level.value.trim() }) })
            .then(r => r.json().then(data => ({ status: r.status, data })))
            .then(({ status, data }) => {
                if (status === 200 && data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                    form.reset();
                    loadSchool();
                } else {
                    document.getElementById('addStudentFormError').textContent = data.message || data.error || 'Failed to add student.';
                    document.getElementById('addStudentFormError').classList.remove('d-none');
                }
            })
            .catch(() => { document.getElementById('addStudentFormError').textContent = 'Network error.'; document.getElementById('addStudentFormError').classList.remove('d-none'); })
            .finally(() => { this.disabled = false; });
    });

    // ── AI Chat Logic ──────────────────────────────────────────────────────
    const chatMessages = document.getElementById('aiChatMessages');
    const chatInput = document.getElementById('aiChatInput');
    const chatSendBtn = document.getElementById('aiChatSend');
    const imageInput = document.getElementById('aiImageInput');
    const imagePreview = document.getElementById('aiImagePreview');
    const previewImg = document.getElementById('aiPreviewImg');
    const previewName = document.getElementById('aiPreviewName');
    const previewRemove = document.getElementById('aiPreviewRemove');
    const chatToggleBtn = document.getElementById('aiChatToggleBtn');
    const chatHeaderToggle = document.getElementById('aiChatHeaderToggle');
    const chatBody = document.getElementById('aiChatBody');
    const welcomeBlock = document.getElementById('aiWelcomeBlock');
    const assistantToggleBtn = document.getElementById('btnToggleAiAssistant');

    let chatHistory = [];
    let pendingImageB64 = null;
    let pendingImageMime = null;
    let isSending = false;

    function hideWelcome() {
        if (welcomeBlock) welcomeBlock.style.display = 'none';
    }

    function setChatOpen(isOpen) {
        chatBody.classList.toggle('open', isOpen);
        chatToggleBtn.classList.toggle('open', isOpen);
        if (isOpen) {
            chatInput.focus();
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // Toggle chat open/close
    chatHeaderToggle.addEventListener('click', function() {
        setChatOpen(!chatBody.classList.contains('open'));
    });
    assistantToggleBtn.addEventListener('click', function() {
        setChatOpen(!chatBody.classList.contains('open'));
    });

    // Quick action buttons
    document.querySelectorAll('.ai-quick-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const action = this.getAttribute('data-action');
            const msg = this.getAttribute('data-msg');
            if (action === 'upload') {
                setChatOpen(true);
                imageInput.click();
            } else if (msg) {
                setChatOpen(true);
                chatInput.value = msg;
                chatInput.focus();
                chatInput.select();
            }
        });
    });

    // Image upload
    imageInput.addEventListener('change', function() {
        const file = this.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            pendingImageB64 = e.target.result;
            pendingImageMime = file.type || 'image/png';
            previewImg.src = pendingImageB64;
            previewName.textContent = file.name;
            imagePreview.classList.add('active');
        };
        reader.readAsDataURL(file);
    });

    previewRemove.addEventListener('click', function() {
        pendingImageB64 = null;
        pendingImageMime = null;
        imagePreview.classList.remove('active');
        imageInput.value = '';
    });

    function addMessage(text, type) {
        hideWelcome();
        const div = document.createElement('div');
        div.className = 'ai-msg ai-msg--' + type;
        if (type === 'ai') {
            div.innerHTML = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/- (Added|Removed|Updated|Failed)[^\n]*/g, function(m) {
                    const isSuccess = !m.includes('Failed');
                    return '<span style="color:' + (isSuccess ? '#6ee7b7' : '#fca5a5') + '">' + m + '</span>';
                })
                .replace(/\n/g, '<br>');
        } else {
            div.textContent = text;
        }
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return div;
    }

    function addImageMessage(dataUrl) {
        hideWelcome();
        const div = document.createElement('div');
        div.className = 'ai-msg ai-msg--user';
        const img = document.createElement('img');
        img.src = dataUrl;
        img.className = 'ai-msg__img-preview';
        div.appendChild(img);
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTyping() {
        const div = document.createElement('div');
        div.className = 'ai-typing';
        div.id = 'aiTypingIndicator';
        div.innerHTML = '<span></span><span></span><span></span>';
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTyping() {
        const el = document.getElementById('aiTypingIndicator');
        if (el) el.remove();
    }

    async function sendMessage() {
        if (isSending) return;
        const text = chatInput.value.trim();
        const hasImage = !!pendingImageB64;

        if (!text && !hasImage) return;

        isSending = true;
        chatSendBtn.disabled = true;

        if (hasImage) addImageMessage(pendingImageB64);
        if (text) addMessage(text, 'user');

        chatInput.value = '';

        const payload = {
            message: text,
            history: chatHistory,
        };
        if (hasImage) {
            payload.image = pendingImageB64;
            payload.mime_type = pendingImageMime || 'image/png';
        }

        // Clear image preview
        pendingImageB64 = null;
        pendingImageMime = null;
        imagePreview.classList.remove('active');
        imageInput.value = '';

        // Add to history
        chatHistory.push({ role: 'user', text: text || '[image uploaded]' });

        showTyping();

        try {
            const resp = await fetch(aiChatUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify(payload),
            });
            const data = await resp.json().catch(() => ({}));
            hideTyping();

            if (!resp.ok) {
                addMessage(data.message || data.error || ('Request failed (' + resp.status + ').'), 'error');
            } else {
                const replyText = (typeof data.reply === 'string' ? data.reply : '').trim();
                const actionsTaken = Array.isArray(data.actions_taken) ? data.actions_taken : [];
                const pendingStudents = Array.isArray(data.pending_students) ? data.pending_students : [];

                if (replyText) {
                    addMessage(replyText, 'ai');
                    chatHistory.push({ role: 'assistant', text: replyText });
                }

                if (pendingStudents.length > 0) {
                    addMessage('I found ' + pendingStudents.length + ' pending student(s). Say "add them all" to confirm.', 'system');
                }

                if (actionsTaken.length > 0) {
                    addMessage('Completed ' + actionsTaken.length + ' action(s). Student table refreshed.', 'system');
                    loadSchool();
                }

                if (!replyText && actionsTaken.length === 0) {
                    addMessage(data.message || data.error || 'No response received from assistant.', 'error');
                }
            }
        } catch (err) {
            hideTyping();
            addMessage('Network error. Please try again.', 'error');
        }

        isSending = false;
        chatSendBtn.disabled = false;
        chatInput.focus();
    }

    chatSendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 90) + 'px';
    });

    // Finance tab
    function loadFinance() {
        fetch(financeUrl, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                if (data.error) return;
                document.getElementById('finSchoolEarnings').textContent = '$' + (data.school_earnings || 0).toFixed(2);
                document.getElementById('finNerdxShare').textContent = '$' + (data.nerdx_share || 0).toFixed(2);
                document.getElementById('finTotalPaid').textContent = '$' + (data.total_paid || 0).toFixed(2);
                document.getElementById('finAmountDue').textContent = '$' + (data.amount_due || 0).toFixed(2);

                const payments = data.payments || [];
                const tbody = document.getElementById('paymentsBody');
                if (payments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No payments recorded yet.</td></tr>';
                } else {
                    tbody.innerHTML = payments.map(function(p) {
                        const date = p.created_at ? new Date(p.created_at).toLocaleDateString() : '\u2014';
                        const amount = '$' + parseFloat(p.amount || 0).toFixed(2);
                        const method = p.payment_method === 'ecocash' ? 'EcoCash' : 'Bank Transfer';
                        const statusClass = p.status === 'paid' || p.status === 'verified' ? 'bg-success' : (p.status === 'pending' ? 'bg-warning' : 'bg-danger');
                        const receiptBtn = p.receipt_url ? '<a href="' + escapeHtml(p.receipt_url) + '" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-eye"></i></a>' : '\u2014';
                        let actions = '';
                        if (p.status === 'pending') {
                            actions = '<button class="btn btn-sm btn-success me-1" onclick="verifyPayment(' + p.id + ', \'verified\')"><i class="fas fa-check"></i></button>' +
                                      '<button class="btn btn-sm btn-danger" onclick="verifyPayment(' + p.id + ', \'rejected\')"><i class="fas fa-times"></i></button>';
                        } else {
                            actions = '<span class="badge ' + statusClass + '">' + escapeHtml(p.status) + '</span>';
                        }
                        return '<tr><td>' + escapeHtml(date) + '</td><td>' + escapeHtml(amount) + '</td><td>' + escapeHtml(method) + '</td><td>' + (p.num_students || 0) + '</td><td><span class="badge ' + statusClass + '">' + escapeHtml(p.status) + '</span></td><td>' + receiptBtn + '</td><td>' + actions + '</td></tr>';
                    }).join('');
                }
            })
            .catch(function() {});
    }

    window.verifyPayment = function(paymentId, status) {
        const note = prompt('Admin notes (optional):') || '';
        fetch(paymentsUrl + '/' + paymentId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ status: status, admin_notes: note }),
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) loadFinance();
        });
    };

    // Load finance when tab is shown
    document.querySelector('a[href="#tabFinance"]').addEventListener('shown.bs.tab', loadFinance);

    loadSchool();
})();
</script>
{% endblock %}
