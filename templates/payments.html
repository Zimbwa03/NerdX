{% extends "base.html" %}

{% block title %}EcoCash Payment Review - NerdX Dashboard{% endblock %}

{% block extra_head %}
<style>
.payment-card {
    border: 1px solid #e3e6f0;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s;
}
.payment-card:hover {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}
.payment-header {
    background-color: #f8f9fc;
    padding: 1rem;
    border-bottom: 1px solid #e3e6f0;
}
.payment-body {
    padding: 1.5rem;
}
.payment-actions {
    padding: 1rem;
    background-color: #f8f9fc;
    border-top: 1px solid #e3e6f0;
}
.btn-approve {
    background-color: #1cc88a;
    border-color: #1cc88a;
    color: white;
}
.btn-approve:hover {
    background-color: #17a673;
    border-color: #17a673;
    color: white;
}
.btn-reject {
    background-color: #e74a3b;
    border-color: #e74a3b;
    color: white;
}
.btn-reject:hover {
    background-color: #c82333;
    border-color: #bd2130;
    color: white;
}
.confirmation-message {
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 0.25rem;
    padding: 0.75rem;
    font-family: monospace;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0">ðŸ’³ EcoCash Payment Review</h1>
                    <p class="text-muted">Review and process pending EcoCash payments</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshPendingPayments()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pending Reviews
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="pendingCount">
                                0
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Value Pending
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalPendingValue">
                                $0.00
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Credits to Distribute
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalCredits">
                                0
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-coins fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Payments List -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-list"></i> Pending Payment Reviews
            </h6>
        </div>
        <div class="card-body">
            <div id="pendingPaymentsList">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Loading pending payments...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Confirm Action</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                Are you sure you want to proceed?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmButton">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Rejection Reason Modal -->
<div class="modal fade" id="rejectionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Payment</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="rejectionReason">Reason for rejection:</label>
                    <select class="form-control" id="rejectionReason">
                        <option value="Payment not received">Payment not received</option>
                        <option value="Incorrect amount">Incorrect amount</option>
                        <option value="Duplicate transaction">Duplicate transaction</option>
                        <option value="User verification failed">User verification failed</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group" id="customReasonGroup" style="display: none;">
                    <label for="customReason">Custom reason:</label>
                    <textarea class="form-control" id="customReason" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-reject" onclick="confirmRejectPayment()">
                    Reject Payment
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let pendingPayments = [];
let currentPaymentForAction = null;

document.addEventListener('DOMContentLoaded', function() {
    loadPendingPayments();
    
    // Show custom reason field when "Other" is selected
    document.getElementById('rejectionReason').addEventListener('change', function() {
        const customGroup = document.getElementById('customReasonGroup');
        if (this.value === 'Other') {
            customGroup.style.display = 'block';
        } else {
            customGroup.style.display = 'none';
        }
    });
});

async function loadPendingPayments() {
    try {
        const response = await fetch('/api/pending-payments');
        const data = await response.json();
        
        pendingPayments = data.pending_payments || [];
        updateStats();
        renderPendingPayments();
        
    } catch (error) {
        console.error('Error loading pending payments:', error);
        document.getElementById('pendingPaymentsList').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Error loading pending payments. Please try again.
            </div>
        `;
    }
}

function updateStats() {
    const pendingCount = pendingPayments.length;
    const totalValue = pendingPayments.reduce((sum, payment) => sum + (payment.money_paid || 0), 0);
    const totalCredits = pendingPayments.reduce((sum, payment) => sum + (payment.credits_purchased || 0), 0);
    
    document.getElementById('pendingCount').textContent = pendingCount;
    document.getElementById('totalPendingValue').textContent = `$${totalValue.toFixed(2)}`;
    document.getElementById('totalCredits').textContent = totalCredits;
}

function renderPendingPayments() {
    const container = document.getElementById('pendingPaymentsList');
    
    if (pendingPayments.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5>No Pending Payments</h5>
                <p class="text-muted">All payments have been processed!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    pendingPayments.forEach((payment, index) => {
        const paymentCard = document.createElement('div');
        paymentCard.className = 'payment-card';
        
        const transactionDate = new Date(payment.time_of_transaction).toLocaleString();
        
        paymentCard.innerHTML = `
            <div class="payment-header">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-1">
                            <i class="fas fa-user"></i> ${payment.student_name}
                        </h6>
                        <small class="text-muted">Transaction: ${payment.transaction_reference}</small>
                    </div>
                    <div class="col-md-4 text-md-right">
                        <span class="badge badge-warning">Pending Review</span>
                    </div>
                </div>
            </div>
            
            <div class="payment-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td><strong>Time:</strong></td>
                                <td>${transactionDate}</td>
                            </tr>
                            <tr>
                                <td><strong>Amount Paid:</strong></td>
                                <td class="text-success"><strong>$${payment.money_paid}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>Credits:</strong></td>
                                <td class="text-info"><strong>${payment.credits_purchased}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>User ID:</strong></td>
                                <td><code>${payment.user_id}</code></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <label class="font-weight-bold">EcoCash Confirmation Message:</label>
                        <div class="confirmation-message">
                            ${payment.ecocash_confirmation_message}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="payment-actions">
                <div class="d-flex justify-content-end">
                    <button class="btn btn-approve mr-2" onclick="approvePayment('${payment.transaction_reference}', ${index})">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="btn btn-reject" onclick="showRejectModal('${payment.transaction_reference}', ${index})">
                        <i class="fas fa-times"></i> Reject
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(paymentCard);
    });
}

function approvePayment(transactionRef, index) {
    const payment = pendingPayments[index];
    
    document.getElementById('modalTitle').textContent = 'Approve Payment';
    document.getElementById('modalBody').innerHTML = `
        <p>Are you sure you want to approve this payment?</p>
        <ul>
            <li><strong>Student:</strong> ${payment.student_name}</li>
            <li><strong>Amount:</strong> $${payment.money_paid}</li>
            <li><strong>Credits:</strong> ${payment.credits_purchased}</li>
        </ul>
        <p class="text-success"><strong>This will add ${payment.credits_purchased} credits to the student's account.</strong></p>
    `;
    
    document.getElementById('confirmButton').className = 'btn btn-approve';
    document.getElementById('confirmButton').innerHTML = '<i class="fas fa-check"></i> Approve Payment';
    document.getElementById('confirmButton').onclick = () => confirmApprovePayment(transactionRef, index);
    
    $('#confirmationModal').modal('show');
}

async function confirmApprovePayment(transactionRef, index) {
    try {
        $('#confirmationModal').modal('hide');
        
        // Show loading state
        const paymentCard = document.querySelectorAll('.payment-card')[index];
        paymentCard.style.opacity = '0.5';
        
        const response = await fetch('/api/approve-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                transaction_reference: transactionRef,
                amount_paid: pendingPayments[index].money_paid
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remove from pending list
            pendingPayments.splice(index, 1);
            updateStats();
            renderPendingPayments();
            
            // Show success message
            showAlert('Payment approved successfully! Credits have been added to the student\'s account.', 'success');
        } else {
            paymentCard.style.opacity = '1';
            showAlert(result.message || 'Failed to approve payment', 'danger');
        }
        
    } catch (error) {
        console.error('Error approving payment:', error);
        showAlert('Error approving payment. Please try again.', 'danger');
    }
}

function showRejectModal(transactionRef, index) {
    currentPaymentForAction = { transactionRef, index };
    document.getElementById('rejectionReason').value = 'Payment not received';
    document.getElementById('customReasonGroup').style.display = 'none';
    document.getElementById('customReason').value = '';
    $('#rejectionModal').modal('show');
}

async function confirmRejectPayment() {
    if (!currentPaymentForAction) return;
    
    const reasonSelect = document.getElementById('rejectionReason');
    let reason = reasonSelect.value;
    
    if (reason === 'Other') {
        const customReason = document.getElementById('customReason').value.trim();
        if (!customReason) {
            showAlert('Please provide a custom reason for rejection.', 'warning');
            return;
        }
        reason = customReason;
    }
    
    try {
        $('#rejectionModal').modal('hide');
        
        const { transactionRef, index } = currentPaymentForAction;
        
        // Show loading state
        const paymentCard = document.querySelectorAll('.payment-card')[index];
        paymentCard.style.opacity = '0.5';
        
        const response = await fetch('/api/reject-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                transaction_reference: transactionRef,
                reason: reason
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remove from pending list
            pendingPayments.splice(index, 1);
            updateStats();
            renderPendingPayments();
            
            // Show success message
            showAlert('Payment rejected successfully.', 'info');
        } else {
            paymentCard.style.opacity = '1';
            showAlert(result.message || 'Failed to reject payment', 'danger');
        }
        
    } catch (error) {
        console.error('Error rejecting payment:', error);
        showAlert('Error rejecting payment. Please try again.', 'danger');
    }
    
    currentPaymentForAction = null;
}

function refreshPendingPayments() {
    loadPendingPayments();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    // Insert at the top of the container
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}