{% extends "base.html" %}

{% block title %}User Analytics - NerdX Dashboard{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0">ðŸ‘¥ User Analytics</h1>
                    <p class="text-muted">Comprehensive user behavior and engagement analysis</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshAnalytics()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Overview Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Students
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalStudents">
                                0
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-graduation-cap fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Active This Week
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="activeWeek">
                                0
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Avg. Session Time
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="avgSessionTime">
                                0 min
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Retention Rate
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="retentionRate">
                                0%
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- User Activity Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">User Activity Trends (Last 30 Days)</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="userActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subject Engagement -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Subject Engagement</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="subjectEngagementChart"></canvas>
                    </div>
                    <div class="mt-4 text-center small">
                        <span class="mr-2">
                            <i class="fas fa-circle text-primary"></i> Mathematics
                        </span>
                        <span class="mr-2">
                            <i class="fas fa-circle text-success"></i> English
                        </span>
                        <span class="mr-2">
                            <i class="fas fa-circle text-info"></i> Sciences
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Section -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Student Directory</h6>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="searchUsers" placeholder="Search students...">
                </div>
                <div class="col-md-3">
                    <select class="form-control" id="filterStatus">
                        <option value="">All Students</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-primary" onclick="exportUserData()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered" id="usersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>NerdX ID</th>
                            <th>Registration Date</th>
                            <th>Credits</th>
                            <th>Total Attempts</th>
                            <th>Accuracy</th>
                            <th>Last Activity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="8" class="text-center">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <span id="usersPagination">Showing 0 of 0 students</span>
                </div>
                <div class="col-md-6">
                    <nav>
                        <ul class="pagination pagination-sm justify-content-end" id="paginationControls">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let userActivityChart, subjectEngagementChart;
let currentPage = 1;
let totalPages = 1;

document.addEventListener('DOMContentLoaded', function() {
    loadUserAnalytics();
    loadUserDirectory();
    createCharts();
});

async function loadUserAnalytics() {
    try {
        const [statsResponse, activityResponse] = await Promise.all([
            fetch('/api/stats'),
            fetch('/api/activity')
        ]);
        
        const stats = await statsResponse.json();
        const activity = await activityResponse.json();
        
        // Update overview cards
        document.getElementById('totalStudents').textContent = stats.total_users || 0;
        document.getElementById('activeWeek').textContent = activity.question_activity?.this_week || 0;
        
        // Calculate sample metrics (in production, these would come from real analytics)
        document.getElementById('avgSessionTime').textContent = '15 min';
        document.getElementById('retentionRate').textContent = '78%';
        
        // Update charts with real data
        updateUserActivityChart(activity.daily_active_users || []);
        
    } catch (error) {
        console.error('Error loading user analytics:', error);
    }
}

async function loadUserDirectory() {
    try {
        const response = await fetch(`/api/users?page=${currentPage}&limit=10`);
        const data = await response.json();
        
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';
        
        if (data.users && data.users.length > 0) {
            data.users.forEach(user => {
                const row = document.createElement('tr');
                
                const registrationDate = new Date(user.registration_date).toLocaleDateString();
                const lastActivity = user.last_activity ? 
                    new Date(user.last_activity).toLocaleDateString() : 'Never';
                
                const accuracy = user.total_attempts > 0 ? 
                    Math.round((user.correct_answers / user.total_attempts) * 100) : 0;
                
                const status = user.last_activity && 
                    new Date(user.last_activity) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) ? 
                    'Active' : 'Inactive';
                
                row.innerHTML = `
                    <td><strong>${user.name} ${user.surname}</strong></td>
                    <td><code>${user.nerdx_id}</code></td>
                    <td>${registrationDate}</td>
                    <td><span class="badge badge-info">${user.credits}</span></td>
                    <td>${user.total_attempts}</td>
                    <td>${accuracy}%</td>
                    <td>${lastActivity}</td>
                    <td>
                        <span class="badge badge-${status === 'Active' ? 'success' : 'secondary'}">
                            ${status}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update pagination
            totalPages = data.pages;
            updatePagination(data);
            
        } else {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">No students found</td></tr>';
        }
        
    } catch (error) {
        console.error('Error loading user directory:', error);
    }
}

function createCharts() {
    // User Activity Chart
    const activityCtx = document.getElementById('userActivityChart').getContext('2d');
    userActivityChart = new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Daily Active Users',
                data: [],
                borderColor: 'rgb(78, 115, 223)',
                backgroundColor: 'rgba(78, 115, 223, 0.05)',
                borderWidth: 2,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Subject Engagement Chart  
    const engagementCtx = document.getElementById('subjectEngagementChart').getContext('2d');
    subjectEngagementChart = new Chart(engagementCtx, {
        type: 'doughnut',
        data: {
            labels: ['Mathematics', 'English', 'Biology', 'Chemistry', 'Physics'],
            datasets: [{
                data: [35, 25, 20, 12, 8],
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#c82333'],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
            }],
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            },
            cutout: '80%',
        },
    });
}

function updateUserActivityChart(activityData) {
    if (userActivityChart && activityData.length > 0) {
        const labels = activityData.map(item => new Date(item.date).toLocaleDateString());
        const users = activityData.map(item => item.users);
        
        userActivityChart.data.labels = labels.reverse();
        userActivityChart.data.datasets[0].data = users.reverse();
        userActivityChart.update();
    }
}

function updatePagination(data) {
    const pagination = document.getElementById('usersPagination');
    const controls = document.getElementById('paginationControls');
    
    pagination.textContent = `Showing ${data.users.length} of ${data.total} students`;
    
    controls.innerHTML = '';
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + (currentPage - 1) + ')">Previous</a>';
    controls.appendChild(prevLi);
    
    // Page numbers
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + i + ')">' + i + '</a>';
        controls.appendChild(pageLi);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + (currentPage + 1) + ')">Next</a>';
    controls.appendChild(nextLi);
}

function changePage(page) {
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        loadUserDirectory();
    }
}

function refreshAnalytics() {
    loadUserAnalytics();
    loadUserDirectory();
}

function exportUserData() {
    // Placeholder for export functionality
    alert('User data export feature coming soon!');
}
</script>
{% endblock %}