{% extends "base.html" %}

{% block title %}System Overview - NerdX Dashboard{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0">ðŸŽ¯ System Overview</h1>
                    <p class="text-muted">NerdX ZIMSEC Education Assistant - Real-time monitoring</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Students
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalUsers">
                                0
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Active Today
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="activeToday">
                                0
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Questions Answered
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="questionsAnswered">
                                0
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-question-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Total Revenue
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalRevenue">
                                $0.00
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Growth Metrics -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Growth Metrics</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 text-center border-right">
                            <div class="h5 mb-0 font-weight-bold text-success" id="newUsersWeek">0</div>
                            <div class="text-xs text-muted">New Users (7 days)</div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="h5 mb-0 font-weight-bold text-info" id="arpu">$0.00</div>
                            <div class="text-xs text-muted">ARPU (Average Revenue Per User)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">System Health</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Database</span>
                            <span class="badge" id="dbStatus">Checking...</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>WhatsApp API</span>
                            <span class="badge bg-success">Connected</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>AI Services</span>
                            <span class="badge bg-success">Active</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Payment Gateway</span>
                            <span class="badge bg-warning">Limited</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Chart and Recent Users -->
    <div class="row mb-4">
        <!-- Daily Activity Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Daily Active Users (Last 30 Days)</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="dailyActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Registrations -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Registrations</h6>
                </div>
                <div class="card-body">
                    <div id="recentUsers">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a href="/analytics" class="btn btn-outline-primary btn-block">
                                <i class="fas fa-users"></i> View User Analytics
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="/revenue" class="btn btn-outline-success btn-block">
                                <i class="fas fa-chart-line"></i> Revenue Dashboard
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="/payments" class="btn btn-outline-warning btn-block">
                                <i class="fas fa-credit-card"></i> Review Payments
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-outline-info btn-block" onclick="exportSystemReport()">
                                <i class="fas fa-download"></i> Export Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let dailyActivityChart;

document.addEventListener('DOMContentLoaded', function() {
    loadOverviewData();
    createDailyActivityChart();
    loadRecentUsers();
    
    // Auto-refresh dashboard every 2 minutes
    setInterval(() => {
        loadOverviewData();
        loadAdvancedMetrics();
    }, 2 * 60 * 1000);
});

async function loadOverviewData() {
    try {
        console.log('Loading dashboard data...');
        const response = await fetch('/api/stats');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Dashboard data loaded successfully:', data);
        
        // Update metrics
        document.getElementById('totalUsers').textContent = data.total_users || 0;
        document.getElementById('activeToday').textContent = data.active_users_today || 0;
        document.getElementById('questionsAnswered').textContent = data.total_questions_answered || 0;
        document.getElementById('totalRevenue').textContent = `$${data.total_revenue || 0}`;
        
        // Update growth metrics
        document.getElementById('newUsersWeek').textContent = data.new_registrations_week || 0;
        document.getElementById('arpu').textContent = `$${data.arpu || 0}`;
        
        // Update database status
        const dbStatus = document.getElementById('dbStatus');
        if (data.database_status === 'connected') {
            dbStatus.className = 'badge bg-success';
            dbStatus.textContent = 'Connected';
        } else {
            dbStatus.className = 'badge bg-danger';
            dbStatus.textContent = 'Disconnected';
        }
        
        // Load system health and advanced metrics
        loadSystemHealth();
        loadAdvancedMetrics();
        
        // Hide loading state
        console.log('Loading state hidden');
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        // Show error in UI
        document.getElementById('totalUsers').textContent = 'Error';
        document.getElementById('activeToday').textContent = 'Error';
        document.getElementById('questionsAnswered').textContent = 'Error';
        document.getElementById('totalRevenue').textContent = 'Error';
    }
}

async function createDailyActivityChart() {
    try {
        const response = await fetch('/api/activity');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        const ctx = document.getElementById('dailyActivityChart').getContext('2d');
        
        const chartData = data.daily_active_users || [];
        const labels = chartData.map(item => new Date(item.date).toLocaleDateString());
        const users = chartData.map(item => item.users);
        
        dailyActivityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Daily Active Users',
                    data: users,
                    borderColor: 'rgb(78, 115, 223)',
                    backgroundColor: 'rgba(78, 115, 223, 0.05)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
    } catch (error) {
        console.error('Error creating activity chart:', error);
        // Show error message in chart area
        document.getElementById('dailyActivityChart').parentElement.innerHTML = '<p class="text-center text-danger">Error loading chart data</p>';
    }
}

async function loadRecentUsers() {
    try {
        console.log('Loading recent users...');
        const response = await fetch('/api/users?limit=5', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            if (response.status === 302 || response.status === 401) {
                // Authentication issue - redirect to login
                window.location.href = '/login';
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Recent users data:', data);
        
        const container = document.getElementById('recentUsers');
        
        if (!container) {
            console.error('recentUsers container not found');
            return;
        }
        
        if (data.users && data.users.length > 0) {
            container.innerHTML = '';
            
            data.users.slice(0, 5).forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'mb-3 pb-2 border-bottom';
                
                let registrationDate = 'Unknown';
                if (user.registration_date) {
                    try {
                        registrationDate = new Date(user.registration_date).toLocaleDateString();
                    } catch (dateError) {
                        console.warn('Date parsing error:', dateError);
                        registrationDate = 'Invalid Date';
                    }
                }
                
                userDiv.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="font-weight-bold">${user.name || 'Unknown'} ${user.surname || ''}</div>
                            <small class="text-muted">ID: ${user.nerdx_id || user.chat_id || 'N/A'}</small>
                        </div>
                        <div class="text-right">
                            <small class="text-muted">${registrationDate}</small>
                            <div class="badge bg-info">${user.credits || 0} credits</div>
                        </div>
                    </div>
                `;
                
                container.appendChild(userDiv);
            });
            
            console.log('Recent users loaded successfully');
        } else {
            container.innerHTML = '<div class="text-muted text-center">No recent users</div>';
            console.log('No recent users found');
        }
        
    } catch (error) {
        console.error('Error loading recent users:', error);
        console.error('Error details:', error.message, error.stack);
        
        const container = document.getElementById('recentUsers');
        if (container) {
            container.innerHTML = '<div class="text-danger text-center">Error loading users</div>';
        }
    }
}

function refreshData() {
    loadOverviewData();
    if (dailyActivityChart) {
        dailyActivityChart.destroy();
    }
    createDailyActivityChart();
    loadRecentUsers();
}

async function loadSystemHealth() {
    try {
        const response = await fetch('/api/system/health');
        const health = await response.json();
        
        // Update system health indicators
        updateHealthIndicator('Database', health.database);
        updateHealthIndicator('WhatsApp API', health.whatsapp_api);
        updateHealthIndicator('AI Services', health.ai_services?.deepseek || health.ai_services?.gemini);
        updateHealthIndicator('Payment Gateway', health.payment_gateway);
        
    } catch (error) {
        console.error('Error loading system health:', error);
    }
}

function updateHealthIndicator(service, status) {
    // This would update the health indicators in the UI
    // For now, we'll keep the static indicators
}

async function loadAdvancedMetrics() {
    try {
        const [activityResponse, engagementResponse] = await Promise.all([
            fetch('/api/activity'),
            fetch('/api/users/engagement')
        ]);
        
        const activity = await activityResponse.json();
        const engagement = await engagementResponse.json();
        
        // Update activity metrics if we have weekly summary
        if (activity.weekly_summary) {
            document.getElementById('activeToday').textContent = activity.weekly_summary.total_active_users || 0;
            
            // Add growth indicator
            const activeElement = document.getElementById('activeToday').parentElement;
            if (activity.weekly_summary.new_users > 0) {
                activeElement.innerHTML += `<small class="text-success"><i class="fas fa-arrow-up"></i> +${activity.weekly_summary.new_users} this week</small>`;
            }
        }
        
        // Update engagement metrics
        if (engagement.engagement_summary) {
            const summary = engagement.engagement_summary;
            console.log('Engagement Summary:', summary);
            
            // You could add engagement indicators to the dashboard
            // For example, update retention metrics
        }
        
    } catch (error) {
        console.error('Error loading advanced metrics:', error);
    }
}

function exportSystemReport() {
    // Generate and download system report
    const reportData = {
        timestamp: new Date().toISOString(),
        metrics: {
            totalUsers: document.getElementById('totalUsers').textContent,
            activeToday: document.getElementById('activeToday').textContent,
            questionsAnswered: document.getElementById('questionsAnswered').textContent,
            totalRevenue: document.getElementById('totalRevenue').textContent,
            newUsersWeek: document.getElementById('newUsersWeek').textContent,
            arpu: document.getElementById('arpu').textContent
        }
    };
    
    const dataStr = JSON.stringify(reportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `nerdx-system-report-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}
</script>
{% endblock %}