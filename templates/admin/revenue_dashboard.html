<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revenue Analytics - NerdX Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .revenue-card {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .profit-positive {
            color: #28a745;
            font-weight: bold;
        }
        .profit-negative {
            color: #dc3545;
            font-weight: bold;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .package-stat {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="revenue-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2><i class="fas fa-chart-line me-2"></i>Revenue Analytics Dashboard</h2>
                            <p class="mb-0">Comprehensive business performance metrics</p>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-light text-dark mb-2">
                                ðŸ’° Net Profit: ${{ "%.2f"|format(business_analytics.net_profit) }}
                            </div>
                            <br>
                            <div class="badge bg-light text-dark">
                                ðŸ“Š Margin: {{ "%.1f"|format(business_analytics.profit_margin) }}%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Performance Metrics -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card">
                            <div class="display-6 text-success mb-2">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <h3 class="text-success">${{ "%.2f"|format(business_analytics.total_revenue) }}</h3>
                            <p class="text-muted mb-0">Total Revenue</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card">
                            <div class="display-6 text-primary mb-2">
                                <i class="fas fa-coins"></i>
                            </div>
                            <h3 class="text-primary">{{ business_analytics.total_credits_sold }}</h3>
                            <p class="text-muted mb-0">Credits Sold</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card">
                            <div class="display-6 text-info mb-2">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <h3 class="{{ 'profit-positive' if business_analytics.net_profit >= 0 else 'profit-negative' }}">
                                ${{ "%.2f"|format(business_analytics.net_profit) }}
                            </h3>
                            <p class="text-muted mb-0">Net Profit</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card">
                            <div class="display-6 text-warning mb-2">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <h3 class="{{ 'profit-positive' if business_analytics.profit_margin >= 0 else 'profit-negative' }}">
                                {{ "%.1f"|format(business_analytics.profit_margin) }}%
                            </h3>
                            <p class="text-muted mb-0">Profit Margin</p>
                        </div>
                    </div>
                </div>

                <!-- Cost Analysis & Monthly Performance -->
                <div class="row">
                    <div class="col-lg-4">
                        <div class="chart-container">
                            <h5><i class="fas fa-calculator text-primary me-2"></i>Cost Structure</h5>
                            <div class="mb-3">
                                <label class="form-label">Cost per Credit (Operational)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" class="form-control" 
                                           value="{{ "%.3f"|format(business_analytics.cost_per_credit_operational) }}" readonly>
                                </div>
                                <small class="text-muted">Our internal cost</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Price per Credit (User)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" class="form-control" 
                                           value="{{ "%.3f"|format(business_analytics.cost_per_credit_user) }}" readonly>
                                </div>
                                <small class="text-muted">What users pay</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Markup</label>
                                <div class="input-group">
                                    <input type="text" class="form-control text-success" 
                                           value="{{ "%.1f"|format(business_analytics.markup_percentage) }}%" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                                <small class="text-success">Profit per credit: ${{ "%.3f"|format(business_analytics.cost_per_credit_user - business_analytics.cost_per_credit_operational) }}</small>
                            </div>
                            
                            <div class="alert alert-info">
                                <strong>Break-even Analysis:</strong><br>
                                Need {{ (business_analytics.total_operational_cost / (business_analytics.cost_per_credit_user - business_analytics.cost_per_credit_operational))|round|int }} credits sold to cover operational costs.
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-8">
                        <div class="chart-container">
                            <h5><i class="fas fa-chart-bar text-primary me-2"></i>Monthly Revenue & Profit</h5>
                            <canvas id="monthlyChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Package Performance & Transaction Details -->
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h5><i class="fas fa-box text-primary me-2"></i>Package Performance</h5>
                            {% for package_id, stats in package_stats.items() %}
                            <div class="package-stat">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>{{ stats.name }}</strong>
                                        <br><small class="text-muted">{{ stats.count }} transactions</small>
                                    </div>
                                    <div class="text-end">
                                        <strong class="text-success">${{ "%.2f"|format(stats.revenue) }}</strong>
                                        <br><small class="text-muted">{{ stats.credits }} credits</small>
                                    </div>
                                </div>
                                <div class="progress mt-2" style="height: 6px;">
                                    <div class="progress-bar" style="width: {{ (stats.revenue / business_analytics.total_revenue * 100) if business_analytics.total_revenue > 0 else 0 }}%"></div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h5><i class="fas fa-list text-primary me-2"></i>Business Insights</h5>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Average Transaction Value:</span>
                                    <strong class="text-success">${{ "%.2f"|format(business_analytics.avg_transaction_value) }}</strong>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Total Transactions:</span>
                                    <strong>{{ business_analytics.total_transactions }}</strong>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Total Operational Cost:</span>
                                    <strong class="text-warning">${{ "%.2f"|format(business_analytics.total_operational_cost) }}</strong>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Revenue per Credit:</span>
                                    <strong>${{ "%.3f"|format(business_analytics.total_revenue / business_analytics.total_credits_sold if business_analytics.total_credits_sold > 0 else 0) }}</strong>
                                </div>
                            </div>
                            
                            {% if business_analytics.net_profit > 0 %}
                            <div class="alert alert-success">
                                <i class="fas fa-arrow-up me-2"></i>
                                <strong>Profitable!</strong> 
                                You're making ${{ "%.3f"|format(business_analytics.net_profit / business_analytics.total_credits_sold if business_analytics.total_credits_sold > 0 else 0) }} profit per credit sold.
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Review Needed:</strong> 
                                Current costs may need optimization.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Recent High-Value Transactions -->
                {% if recent_payments %}
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <h5><i class="fas fa-history text-primary me-2"></i>Recent Transactions</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Package</th>
                                            <th>Revenue</th>
                                            <th>Credits</th>
                                            <th>Cost</th>
                                            <th>Profit</th>
                                            <th>Margin</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for payment in recent_payments %}
                                        {% set cost = payment.credits * business_analytics.cost_per_credit_operational %}
                                        {% set profit = payment.amount - cost %}
                                        {% set margin = (profit / payment.amount * 100) if payment.amount > 0 else 0 %}
                                        <tr>
                                            <td>{{ payment.approved_at[:10] if payment.approved_at else 'N/A' }}</td>
                                            <td>{{ payment.package_id|title }}</td>
                                            <td class="text-success">${{ "%.2f"|format(payment.amount) }}</td>
                                            <td>{{ payment.credits }}</td>
                                            <td class="text-warning">${{ "%.3f"|format(cost) }}</td>
                                            <td class="{{ 'text-success' if profit >= 0 else 'text-danger' }}">
                                                ${{ "%.3f"|format(profit) }}
                                            </td>
                                            <td class="{{ 'text-success' if margin >= 0 else 'text-danger' }}">
                                                {{ "%.1f"|format(margin) }}%
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Action Buttons -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex gap-3">
                            <a href="{{ url_for('admin_payment_dashboard.payment_dashboard') }}" class="btn btn-primary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Payments
                            </a>
                            <button onclick="window.print()" class="btn btn-secondary">
                                <i class="fas fa-print me-2"></i>Print Report
                            </button>
                            <button onclick="exportData()" class="btn btn-info">
                                <i class="fas fa-download me-2"></i>Export Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Monthly Revenue Chart
        const monthlyData = {{ monthly_data | tojsonfilter | safe }};
        const months = monthlyData.map(item => item[0]);
        const revenues = monthlyData.map(item => item[1].revenue);
        const profits = monthlyData.map(item => item[1].profit);
        const operationalCosts = monthlyData.map(item => item[1].operational_cost);

        const ctx = document.getElementById('monthlyChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'Revenue',
                        data: revenues,
                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Operational Cost',
                        data: operationalCosts,
                        backgroundColor: 'rgba(255, 193, 7, 0.8)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Net Profit',
                        data: profits,
                        backgroundColor: 'rgba(23, 162, 184, 0.8)',
                        borderColor: 'rgba(23, 162, 184, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Monthly Revenue, Costs & Profit'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });

        function exportData() {
            // Simple CSV export functionality
            const csvContent = [
                ['Month', 'Revenue', 'Operational Cost', 'Net Profit', 'Transactions'],
                ...monthlyData.map(item => [
                    item[0],
                    item[1].revenue.toFixed(2),
                    item[1].operational_cost.toFixed(3),
                    item[1].profit.toFixed(3),
                    item[1].transactions
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'nerdx_revenue_report.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>